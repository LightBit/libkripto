/*
 * Copyright (C) 2013 Gregor Pintar <grpintar@gmail.com>
 *
 * Permission is granted to deal in this work without any restriction,
 * including unlimited rights to use, publicly perform, publish,
 * reproduce, relicence, modify, merge, and/or distribute in any form,
 * for any purpose, with or without fee, and by any means.
 *
 * This work is provided "AS IS" and WITHOUT WARRANTY of any kind,
 * to the utmost extent permitted by applicable law. In no event
 * shall a licensor, author or contributor be held liable for any
 * issues arising in any way out of dealing in the work.
 */

#include <string.h>
#include <stdint.h>
#include <stdlib.h>
#include <assert.h>

#include <kripto/macros.h>
#include <kripto/memwipe.h>
#include <kripto/mac.h>
#include <kripto/mac_desc.h>
#include <kripto/block.h>

#include <kripto/mac/omac.h>

struct kripto_mac
{
	const kripto_mac_desc *desc;
	kripto_block *block;
	uint8_t *lu;
	uint8_t *lu2;
	uint8_t *buf;
	uint8_t *prev;
	unsigned int len;
	unsigned int i;
	int f;
};

#ifdef OMAC_SWITCH

static void poly(uint8_t *x, unsigned int len)
{
	switch(len)
	{
		case 1:
		case 3:
		case 8:
		case 13:
		case 15:
		case 40:
		case 55:
		case 61:
			x[len - 1] ^= 0x1B;
			break;

		case 2:
			x[len - 1] ^= 0x2B;
			break;

		case 4:
		case 37:
		case 46:
			x[len - 1] ^= 0x8D;
			break;

		case 5:
		case 14:
		case 89:
		case 125:
		case 209:
			x[len - 1] ^= 0x39;
			break;

		case 6:
		case 17:
		case 20:
		case 25:
		case 45:
		case 50:
		case 51:
		case 148:
		case 158:
		case 170:
			x[len - 1] ^= 0x2D;
			break;

		case 7:
		case 18:
			x[len - 1] ^= 0x95;
			break;

		case 9:
		case 189:
		case 222:
			x[len - 2] ^= 0x06;
			x[len - 1] ^= 0x09;
			break;

		case 10:
		case 29:
		case 142:
		case 182:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x15;
			break;

		case 11:
		case 254:
			x[len - 1] ^= 0xC5;
			break;

		case 12:
		case 177:
			x[len - 2] ^= 0x06;
			x[len - 1] ^= 0x41;
			break;

		case 16:
		case 24:
		case 43:
		case 255:
			x[len - 1] ^= 0x87;
			break;

		case 19:
		case 219:
		case 249:
			x[len - 1] ^= 0x4D;
			break;

		case 21:
		case 144:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x0D;
			break;

		case 22:
		case 59:
		case 181:
		case 240:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x0D;
			break;

		case 23:
		case 149:
			x[len - 2] ^= 0x03;
			x[len - 1] ^= 0x81;
			break;

		case 26:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x0B;
			break;

		case 27:
		case 141:
			x[len - 1] ^= 0x8B;
			break;

		case 28:
			x[len - 2] ^= 0x03;
			x[len - 1] ^= 0x09;
			break;

		case 30:
			x[len - 2] ^= 0x01;
			x[len - 1] ^= 0x29;
			break;

		case 31:
			x[len - 2] ^= 0xC4;
			x[len - 1] ^= 0x01;
			break;

		case 32:
		case 234:
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x25;
			break;

		case 33:
			x[len - 2] ^= 0x09;
			x[len - 1] ^= 0x45;
			break;

		case 34:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x0D;
			break;

		case 35:
		case 52:
		case 75:
		case 121:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x25;
			break;

		case 36:
			x[len - 2] ^= 0x0C;
			x[len - 1] ^= 0x03;
			break;

		case 38:
		case 132:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x07;
			break;

		case 39:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x91;
			break;

		case 41:
		case 68:
		case 175:
			x[len - 2] ^= 0x01;
			x[len - 1] ^= 0x0B;
			break;

		case 42:
			x[len - 1] ^= 0x93;
			break;

		case 44:
			x[len - 2] ^= 0x28;
			x[len - 1] ^= 0x41;
			break;

		case 47:
			x[len - 2] ^= 0x01;
			x[len - 1] ^= 0xA1;
			break;

		case 48:
			x[len - 2] ^= 0x10;
			x[len - 1] ^= 0x0D;
			break;

		case 49:
		case 250:
			x[len - 2] ^= 0x24;
			x[len - 1] ^= 0x41;
			break;

		case 53:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x85;
			break;

		case 54:
		case 72:
		case 202:
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x19;
			break;

		case 56:
		case 103:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x51;
			break;

		case 57:
			x[len - 3] ^= 0x04;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x41;
			break;

		case 58:
			x[len - 3] ^= 0x0C;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x01;
			break;

		case 60:
		case 135:
		case 150:
			x[len - 2] ^= 0x82;
			x[len - 1] ^= 0x41;
			break;

		case 62:
			x[len - 3] ^= 0x01;
			x[len - 1] ^= 0x25;
			break;

		case 63:
		case 244:
			x[len - 2] ^= 0xC0;
			x[len - 1] ^= 0x41;
			break;

		case 64:
		case 195:
			x[len - 2] ^= 0x01;
			x[len - 1] ^= 0x25;
			break;

		case 65:
		case 145:
			x[len - 2] ^= 0x88;
			x[len - 1] ^= 0x05;
			break;

		case 66:
		case 178:
		case 210:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x45;
			break;

		case 67:
		case 112:
			x[len - 1] ^= 0xA9;
			break;

		case 69:
		case 226:
			x[len - 3] ^= 0x09;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x01;
			break;

		case 70:
			x[len - 2] ^= 0x0A;
			x[len - 1] ^= 0x41;
			break;

		case 71:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0xC1;
			break;

		case 73:
			x[len - 2] ^= 0x60;
			x[len - 1] ^= 0x09;
			break;

		case 74:
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x49;
			break;

		case 76:
			x[len - 3] ^= 0x08;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x41;
			break;

		case 77:
		case 107:
			x[len - 3] ^= 0x08;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x09;
			break;

		case 78:
		case 84:
		case 95:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x61;
			break;

		case 79:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x07;
			break;

		case 80:
		case 101:
			x[len - 2] ^= 0x40;
			x[len - 1] ^= 0x0D;
			break;

		case 81:
		case 109:
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x0B;
			break;

		case 82:
			x[len - 1] ^= 0xB1;
			break;

		case 83:
			x[len - 2] ^= 0x0B;
			x[len - 1] ^= 0x01;
			break;

		case 85:
			x[len - 3] ^= 0x81;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x01;
			break;

		case 86:
		case 217:
			x[len - 3] ^= 0x08;
			x[len - 2] ^= 0x40;
			x[len - 1] ^= 0x41;
			break;

		case 87:
			x[len - 3] ^= 0x80;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x05;
			break;

		case 88:
		case 167:
		case 188:
		case 220:
			x[len - 2] ^= 0x01;
			x[len - 1] ^= 0x0D;
			break;

		case 90:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x51;
			break;

		case 91:
			x[len - 1] ^= 0x1D;
			break;

		case 92:
			x[len - 2] ^= 0x21;
			x[len - 1] ^= 0x41;
			break;

		case 93:
			x[len - 2] ^= 0x28;
			x[len - 1] ^= 0x03;
			break;

		case 94:
		case 190:
			x[len - 2] ^= 0x24;
			x[len - 1] ^= 0x09;
			break;

		case 96:
			x[len - 3] ^= 0x0A;
			x[len - 1] ^= 0x11;
			break;

		case 97:
			x[len - 2] ^= 0xC0;
			x[len - 1] ^= 0x81;
			break;

		case 98:
		case 140:
			x[len - 2] ^= 0x22;
			x[len - 1] ^= 0x41;
			break;

		case 99:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x89;
			break;

		case 100:
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x83;
			break;

		case 102:
			x[len - 2] ^= 0x09;
			x[len - 1] ^= 0x05;
			break;

		case 104:
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x25;
			break;

		case 105:
		case 173:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x23;
			break;

		case 106:
		case 184:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x13;
			break;

		case 108:
			x[len - 3] ^= 0x20;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x41;
			break;

		case 110:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0xA1;
			break;

		case 111:
		case 172:
			x[len - 3] ^= 0x0C;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x01;
			break;

		case 113:
		case 146:
			x[len - 2] ^= 0x10;
			x[len - 1] ^= 0x85;
			break;

		case 114:
		case 205:
		case 228:
			x[len - 1] ^= 0xA3;
			break;

		case 115:
			x[len - 2] ^= 0x42;
			x[len - 1] ^= 0x41;
			break;

		case 116:
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x0D;
			break;

		case 117:
			x[len - 2] ^= 0xB0;
			x[len - 1] ^= 0x01;
			break;

		case 118:
			x[len - 2] ^= 0x1A;
			x[len - 1] ^= 0x01;
			break;

		case 119:
		case 159:
			x[len - 3] ^= 0x01;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x81;
			break;

		case 120:
		case 165:
		case 183:
			x[len - 2] ^= 0x12;
			x[len - 1] ^= 0x09;
			break;

		case 122:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x41;
			break;

		case 123:
			x[len - 4] ^= 0x01;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x09;
			break;

		case 124:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0xA0;
			x[len - 1] ^= 0x01;
			break;

		case 126:
			x[len - 3] ^= 0x0A;
			x[len - 2] ^= 0x01;
			x[len - 1] ^= 0x01;
			break;

		case 127:
		case 212:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x49;
			break;

		case 128:
			x[len - 3] ^= 0x08;
			x[len - 1] ^= 0x43;
			break;

		case 129:
			x[len - 3] ^= 0x20;
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x09;
			break;

		case 130:
			x[len - 2] ^= 0x85;
			x[len - 1] ^= 0x01;
			break;

		case 131:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x85;
			break;

		case 133:
			x[len - 2] ^= 0x2A;
			x[len - 1] ^= 0x01;
			break;

		case 134:
			x[len - 3] ^= 0x08;
			x[len - 2] ^= 0x03;
			x[len - 1] ^= 0x01;
			break;

		case 136:
			x[len - 3] ^= 0x60;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x01;
			break;

		case 137:
			x[len - 4] ^= 0x01;
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x41;
			break;

		case 138:
			x[len - 3] ^= 0x20;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x41;
			break;

		case 139:
		case 211:
			x[len - 2] ^= 0x81;
			x[len - 1] ^= 0x41;
			break;

		case 143:
			x[len - 2] ^= 0x0A;
			x[len - 1] ^= 0x81;
			break;

		case 147:
			x[len - 2] ^= 0x0A;
			x[len - 1] ^= 0x09;
			break;

		case 151:
		case 179:
			x[len - 2] ^= 0x0C;
			x[len - 1] ^= 0x41;
			break;

		case 152:
			x[len - 4] ^= 0x0A;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x01;
			break;

		case 153:
			x[len - 2] ^= 0x12;
			x[len - 1] ^= 0x81;
			break;

		case 154:
			x[len - 4] ^= 0x02;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x05;
			break;

		case 155:
			x[len - 3] ^= 0x02;
			x[len - 1] ^= 0xA1;
			break;

		case 156:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x29;
			break;

		case 157:
			x[len - 4] ^= 0xC0;
			x[len - 1] ^= 0x05;
			break;

		case 160:
		case 199:
			x[len - 2] ^= 0x10;
			x[len - 1] ^= 0xA1;
			break;

		case 161:
			x[len - 3] ^= 0x81;
			x[len - 1] ^= 0x41;
			break;

		case 162:
		case 164:
			x[len - 2] ^= 0xC0;
			x[len - 1] ^= 0x05;
			break;

		case 163:
			x[len - 3] ^= 0x12;
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x01;
			break;

		case 166:
			x[len - 3] ^= 0x20;
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x09;
			break;

		case 168:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x43;
			break;

		case 169:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x40;
			x[len - 1] ^= 0x41;
			break;

		case 171:
			x[len - 2] ^= 0x82;
			x[len - 1] ^= 0x21;
			break;

		case 174:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x21;
			break;

		case 176:
			x[len - 2] ^= 0x60;
			x[len - 1] ^= 0x41;
			break;

		case 180:
			x[len - 2] ^= 0x60;
			x[len - 1] ^= 0x81;
			break;

		case 185:
			x[len - 2] ^= 0x0C;
			x[len - 1] ^= 0x05;
			break;

		case 186:
			x[len - 2] ^= 0x03;
			x[len - 1] ^= 0x41;
			break;

		case 187:
			x[len - 2] ^= 0x28;
			x[len - 1] ^= 0x11;
			break;

		case 191:
			x[len - 3] ^= 0x06;
			x[len - 1] ^= 0x81;
			break;

		case 192:
			x[len - 3] ^= 0x20;
			x[len - 1] ^= 0x45;
			break;

		case 193:
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x83;
			break;

		case 194:
			x[len - 3] ^= 0x08;
			x[len - 2] ^= 0x10;
			x[len - 1] ^= 0x05;
			break;

		case 196:
			x[len - 3] ^= 0x20;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x81;
			break;

		case 197:
			x[len - 3] ^= 0x10;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x05;
			break;

		case 198:
			x[len - 3] ^= 0x28;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x01;
			break;

		case 200:
			x[len - 2] ^= 0x48;
			x[len - 1] ^= 0x03;
			break;

		case 201:
			x[len - 2] ^= 0xA0;
			x[len - 1] ^= 0x03;
			break;

		case 203:
		case 248:
			x[len - 2] ^= 0x28;
			x[len - 1] ^= 0x21;
			break;

		case 204:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x09;
			break;

		case 206:
			x[len - 3] ^= 0x04;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x03;
			break;

		case 207:
			x[len - 3] ^= 0x08;
			x[len - 2] ^= 0x81;
			x[len - 1] ^= 0x01;
			break;

		case 208:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x41;
			break;

		case 213:
			x[len - 2] ^= 0x48;
			x[len - 1] ^= 0x09;
			break;

		case 214:
			x[len - 2] ^= 0x90;
			x[len - 1] ^= 0x21;
			break;

		case 215:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x44;
			x[len - 1] ^= 0x01;
			break;

		case 216:
			x[len - 2] ^= 0x0C;
			x[len - 1] ^= 0x21;
			break;

		case 218:
			x[len - 3] ^= 0x0C;
			x[len - 1] ^= 0x05;
			break;

		case 221:
			x[len - 4] ^= 0x02;
			x[len - 1] ^= 0x61;
			break;

		case 223:
			x[len - 3] ^= 0xA0;
			x[len - 1] ^= 0x41;
			break;

		case 224:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x40;
			x[len - 1] ^= 0x09;
			break;

		case 225:
			x[len - 3] ^= 0x40;
			x[len - 1] ^= 0x25;
			break;

		case 227:
			x[len - 3] ^= 0x84;
			x[len - 1] ^= 0x03;
			break;

		case 229:
			x[len - 3] ^= 0x04;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x81;
			break;

		case 230:
			x[len - 3] ^= 0x20;
			x[len - 2] ^= 0x04;
			x[len - 1] ^= 0x05;
			break;

		case 231:
			x[len - 3] ^= 0x01;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x09;
			break;

		case 232:
			x[len - 2] ^= 0x0A;
			x[len - 1] ^= 0x11;
			break;

		case 233:
			x[len - 2] ^= 0x0A;
			x[len - 1] ^= 0x03;
			break;

		case 235:
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x15;
			break;

		case 236:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x05;
			break;

		case 237:
			x[len - 4] ^= 0x04;
			x[len - 2] ^= 0x08;
			x[len - 1] ^= 0x05;
			break;

		case 238:
			x[len - 2] ^= 0x18;
			x[len - 1] ^= 0x03;
			break;

		case 239:
			x[len - 3] ^= 0x10;
			x[len - 2] ^= 0x84;
			x[len - 1] ^= 0x01;
			break;

		case 241:
			x[len - 3] ^= 0x03;
			x[len - 1] ^= 0x81;
			break;

		case 242:
			x[len - 2] ^= 0x84;
			x[len - 1] ^= 0x03;
			break;

		case 243:
			x[len - 4] ^= 0x08;
			x[len - 3] ^= 0x44;
			x[len - 1] ^= 0x01;
			break;

		case 245:
			x[len - 3] ^= 0x02;
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x05;
			break;

		case 246:
			x[len - 4] ^= 0x02;
			x[len - 3] ^= 0x08;
			x[len - 2] ^= 0x40;
			x[len - 1] ^= 0x01;
			break;

		case 247:
			x[len - 4] ^= 0x02;
			x[len - 3] ^= 0x0A;
			x[len - 1] ^= 0x01;
			break;

		case 251:
			x[len - 4] ^= 0x04;
			x[len - 3] ^= 0x80;
			x[len - 2] ^= 0x20;
			x[len - 1] ^= 0x01;
			break;

		case 252:
			x[len - 3] ^= 0x20;
			x[len - 2] ^= 0x80;
			x[len - 1] ^= 0x81;
			break;

		case 253:
			x[len - 6] ^= 0x01;
			x[len - 5] ^= 0x08;
			x[len - 2] ^= 0x02;
			x[len - 1] ^= 0x01;
			break;
	}
}
#else

/*
 * Table of Low-Weight Binary Irreducible Polynomials:
 * http://www.hpl.hp.com/techreports/98/HPL-98-135.pdf
 */
static const uint8_t poly[256][6] =
{
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*   0 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*   1 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2B}, /*   2 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*   3 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8D}, /*   4 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /*   5 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*   6 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x95}, /*   7 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*   8 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x09}, /*   9 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /*  10 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xC5}, /*  11 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x41}, /*  12 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  13 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /*  14 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  15 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}, /*  16 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  17 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x95}, /*  18 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x4D}, /*  19 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  20 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x0D}, /*  21 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /*  22 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x81}, /*  23 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}, /*  24 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  25 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x0B}, /*  26 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8B}, /*  27 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x09}, /*  28 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /*  29 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x29}, /*  30 */
	{0x00, 0x00, 0x00, 0x00, 0xC4, 0x01}, /*  31 */
	{0x00, 0x00, 0x00, 0x00, 0x04, 0x25}, /*  32 */
	{0x00, 0x00, 0x00, 0x00, 0x09, 0x45}, /*  33 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x0D}, /*  34 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /*  35 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x03}, /*  36 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8D}, /*  37 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x07}, /*  38 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x91}, /*  39 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  40 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0B}, /*  41 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x93}, /*  42 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}, /*  43 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x41}, /*  44 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  45 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8D}, /*  46 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0xA1}, /*  47 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0x0D}, /*  48 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x41}, /*  49 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  50 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  51 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /*  52 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x85}, /*  53 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x19}, /*  54 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  55 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x51}, /*  56 */
	{0x00, 0x00, 0x00, 0x04, 0x02, 0x41}, /*  57 */
	{0x00, 0x00, 0x00, 0x0C, 0x20, 0x01}, /*  58 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /*  59 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x41}, /*  60 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  61 */
	{0x00, 0x00, 0x00, 0x01, 0x00, 0x25}, /*  62 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x41}, /*  63 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x25}, /*  64 */
	{0x00, 0x00, 0x00, 0x00, 0x88, 0x05}, /*  65 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x45}, /*  66 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA9}, /*  67 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0B}, /*  68 */
	{0x00, 0x00, 0x00, 0x09, 0x02, 0x01}, /*  69 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x41}, /*  70 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0xC1}, /*  71 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x19}, /*  72 */
	{0x00, 0x00, 0x00, 0x00, 0x60, 0x09}, /*  73 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x49}, /*  74 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /*  75 */
	{0x00, 0x00, 0x00, 0x08, 0x20, 0x41}, /*  76 */
	{0x00, 0x00, 0x00, 0x08, 0x04, 0x09}, /*  77 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x61}, /*  78 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x07}, /*  79 */
	{0x00, 0x00, 0x00, 0x00, 0x40, 0x0D}, /*  80 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x0B}, /*  81 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xB1}, /*  82 */
	{0x00, 0x00, 0x00, 0x00, 0x0B, 0x01}, /*  83 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x61}, /*  84 */
	{0x00, 0x00, 0x00, 0x81, 0x02, 0x01}, /*  85 */
	{0x00, 0x00, 0x00, 0x08, 0x40, 0x41}, /*  86 */
	{0x00, 0x00, 0x00, 0x80, 0x04, 0x05}, /*  87 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /*  88 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /*  89 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x51}, /*  90 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1D}, /*  91 */
	{0x00, 0x00, 0x00, 0x00, 0x21, 0x41}, /*  92 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x03}, /*  93 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x09}, /*  94 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x61}, /*  95 */
	{0x00, 0x00, 0x00, 0x0A, 0x00, 0x11}, /*  96 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x81}, /*  97 */
	{0x00, 0x00, 0x00, 0x00, 0x22, 0x41}, /*  98 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x89}, /*  99 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x83}, /* 100 */
	{0x00, 0x00, 0x00, 0x00, 0x40, 0x0D}, /* 101 */
	{0x00, 0x00, 0x00, 0x00, 0x09, 0x05}, /* 102 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x51}, /* 103 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x25}, /* 104 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x23}, /* 105 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x13}, /* 106 */
	{0x00, 0x00, 0x00, 0x08, 0x04, 0x09}, /* 107 */
	{0x00, 0x00, 0x00, 0x20, 0x04, 0x41}, /* 108 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x0B}, /* 109 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0xA1}, /* 110 */
	{0x00, 0x00, 0x00, 0x0C, 0x04, 0x01}, /* 111 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA9}, /* 112 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0x85}, /* 113 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA3}, /* 114 */
	{0x00, 0x00, 0x00, 0x00, 0x42, 0x41}, /* 115 */
	{0x00, 0x00, 0x00, 0x00, 0x04, 0x0D}, /* 116 */
	{0x00, 0x00, 0x00, 0x00, 0xB0, 0x01}, /* 117 */
	{0x00, 0x00, 0x00, 0x00, 0x1A, 0x01}, /* 118 */
	{0x00, 0x00, 0x00, 0x01, 0x02, 0x81}, /* 119 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x09}, /* 120 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /* 121 */
	{0x00, 0x00, 0x00, 0x02, 0x04, 0x41}, /* 122 */
	{0x00, 0x00, 0x01, 0x00, 0x02, 0x09}, /* 123 */
	{0x00, 0x00, 0x00, 0x02, 0xA0, 0x01}, /* 124 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /* 125 */
	{0x00, 0x00, 0x00, 0x0A, 0x01, 0x01}, /* 126 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x49}, /* 127 */
	{0x00, 0x00, 0x00, 0x08, 0x00, 0x43}, /* 128 */
	{0x00, 0x00, 0x00, 0x20, 0x80, 0x09}, /* 129 */
	{0x00, 0x00, 0x00, 0x00, 0x85, 0x01}, /* 130 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x85}, /* 131 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x07}, /* 132 */
	{0x00, 0x00, 0x00, 0x00, 0x2A, 0x01}, /* 133 */
	{0x00, 0x00, 0x00, 0x08, 0x03, 0x01}, /* 134 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x41}, /* 135 */
	{0x00, 0x00, 0x00, 0x60, 0x04, 0x01}, /* 136 */
	{0x00, 0x00, 0x01, 0x00, 0x80, 0x41}, /* 137 */
	{0x00, 0x00, 0x00, 0x20, 0x02, 0x41}, /* 138 */
	{0x00, 0x00, 0x00, 0x00, 0x81, 0x41}, /* 139 */
	{0x00, 0x00, 0x00, 0x00, 0x22, 0x41}, /* 140 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8B}, /* 141 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /* 142 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x81}, /* 143 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x0D}, /* 144 */
	{0x00, 0x00, 0x00, 0x00, 0x88, 0x05}, /* 145 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0x85}, /* 146 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x09}, /* 147 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /* 148 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x81}, /* 149 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x41}, /* 150 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x41}, /* 151 */
	{0x00, 0x00, 0x0A, 0x00, 0x02, 0x01}, /* 152 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x81}, /* 153 */
	{0x00, 0x00, 0x02, 0x00, 0x04, 0x05}, /* 154 */
	{0x00, 0x00, 0x00, 0x02, 0x00, 0xA1}, /* 155 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x29}, /* 156 */
	{0x00, 0x00, 0xC0, 0x00, 0x00, 0x05}, /* 157 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /* 158 */
	{0x00, 0x00, 0x00, 0x01, 0x02, 0x81}, /* 159 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0xA1}, /* 160 */
	{0x00, 0x00, 0x00, 0x81, 0x00, 0x41}, /* 161 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x05}, /* 162 */
	{0x00, 0x00, 0x00, 0x12, 0x80, 0x01}, /* 163 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x05}, /* 164 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x09}, /* 165 */
	{0x00, 0x00, 0x00, 0x20, 0x08, 0x09}, /* 166 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /* 167 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x43}, /* 168 */
	{0x00, 0x00, 0x00, 0x02, 0x40, 0x41}, /* 169 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /* 170 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x21}, /* 171 */
	{0x00, 0x00, 0x00, 0x0C, 0x04, 0x01}, /* 172 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x23}, /* 173 */
	{0x00, 0x00, 0x00, 0x02, 0x80, 0x21}, /* 174 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0B}, /* 175 */
	{0x00, 0x00, 0x00, 0x00, 0x60, 0x41}, /* 176 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x41}, /* 177 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x45}, /* 178 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x41}, /* 179 */
	{0x00, 0x00, 0x00, 0x00, 0x60, 0x81}, /* 180 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /* 181 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /* 182 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x09}, /* 183 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x13}, /* 184 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x05}, /* 185 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x41}, /* 186 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x11}, /* 187 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /* 188 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x09}, /* 189 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x09}, /* 190 */
	{0x00, 0x00, 0x00, 0x06, 0x00, 0x81}, /* 191 */
	{0x00, 0x00, 0x00, 0x20, 0x00, 0x45}, /* 192 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x83}, /* 193 */
	{0x00, 0x00, 0x00, 0x08, 0x10, 0x05}, /* 194 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x25}, /* 195 */
	{0x00, 0x00, 0x00, 0x20, 0x04, 0x81}, /* 196 */
	{0x00, 0x00, 0x00, 0x10, 0x02, 0x05}, /* 197 */
	{0x00, 0x00, 0x00, 0x28, 0x20, 0x01}, /* 198 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0xA1}, /* 199 */
	{0x00, 0x00, 0x00, 0x00, 0x48, 0x03}, /* 200 */
	{0x00, 0x00, 0x00, 0x00, 0xA0, 0x03}, /* 201 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x19}, /* 202 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x21}, /* 203 */
	{0x00, 0x00, 0x00, 0x02, 0x80, 0x09}, /* 204 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA3}, /* 205 */
	{0x00, 0x00, 0x00, 0x04, 0x20, 0x03}, /* 206 */
	{0x00, 0x00, 0x00, 0x08, 0x81, 0x01}, /* 207 */
	{0x00, 0x00, 0x00, 0x02, 0x02, 0x41}, /* 208 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /* 209 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x45}, /* 210 */
	{0x00, 0x00, 0x00, 0x00, 0x81, 0x41}, /* 211 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x49}, /* 212 */
	{0x00, 0x00, 0x00, 0x00, 0x48, 0x09}, /* 213 */
	{0x00, 0x00, 0x00, 0x00, 0x90, 0x21}, /* 214 */
	{0x00, 0x00, 0x00, 0x02, 0x44, 0x01}, /* 215 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x21}, /* 216 */
	{0x00, 0x00, 0x00, 0x08, 0x40, 0x41}, /* 217 */
	{0x00, 0x00, 0x00, 0x0C, 0x00, 0x05}, /* 218 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x4D}, /* 219 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /* 220 */
	{0x00, 0x00, 0x02, 0x00, 0x00, 0x61}, /* 221 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x09}, /* 222 */
	{0x00, 0x00, 0x00, 0xA0, 0x00, 0x41}, /* 223 */
	{0x00, 0x00, 0x00, 0x02, 0x40, 0x09}, /* 224 */
	{0x00, 0x00, 0x00, 0x40, 0x00, 0x25}, /* 225 */
	{0x00, 0x00, 0x00, 0x09, 0x02, 0x01}, /* 226 */
	{0x00, 0x00, 0x00, 0x84, 0x00, 0x03}, /* 227 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA3}, /* 228 */
	{0x00, 0x00, 0x00, 0x04, 0x20, 0x81}, /* 229 */
	{0x00, 0x00, 0x00, 0x20, 0x04, 0x05}, /* 230 */
	{0x00, 0x00, 0x00, 0x01, 0x20, 0x09}, /* 231 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x11}, /* 232 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x03}, /* 233 */
	{0x00, 0x00, 0x00, 0x00, 0x04, 0x25}, /* 234 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x15}, /* 235 */
	{0x00, 0x00, 0x00, 0x02, 0x20, 0x05}, /* 236 */
	{0x00, 0x00, 0x04, 0x00, 0x08, 0x05}, /* 237 */
	{0x00, 0x00, 0x00, 0x00, 0x18, 0x03}, /* 238 */
	{0x00, 0x00, 0x00, 0x10, 0x84, 0x01}, /* 239 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /* 240 */
	{0x00, 0x00, 0x00, 0x03, 0x00, 0x81}, /* 241 */
	{0x00, 0x00, 0x00, 0x00, 0x84, 0x03}, /* 242 */
	{0x00, 0x00, 0x08, 0x44, 0x00, 0x01}, /* 243 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x41}, /* 244 */
	{0x00, 0x00, 0x00, 0x02, 0x80, 0x05}, /* 245 */
	{0x00, 0x00, 0x02, 0x08, 0x40, 0x01}, /* 246 */
	{0x00, 0x00, 0x02, 0x0A, 0x00, 0x01}, /* 247 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x21}, /* 248 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x4D}, /* 249 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x41}, /* 250 */
	{0x00, 0x00, 0x04, 0x80, 0x20, 0x01}, /* 251 */
	{0x00, 0x00, 0x00, 0x20, 0x80, 0x81}, /* 252 */
	{0x01, 0x08, 0x00, 0x00, 0x02, 0x01}, /* 253 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xC5}, /* 254 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}  /* 255 */
};
#endif

static void omac_init(kripto_mac *s)
{
	unsigned int i;
	uint8_t msb;

	memset(s->lu, 0, s->len);
	kripto_block_encrypt(s->block, s->lu, s->lu);

	/* Lu */
	msb = s->lu[0] >> 7;

	for(i = 0; i < (s->len - 1); i++)
		s->lu[i] = (s->lu[i] << 1) | (s->lu[i + 1] >> 7);

	s->lu[i] <<= 1;

	#ifdef OMAC_SWITCH
	if(msb) poly(s->lu, s->len);
	#else
	if(msb)
	{
		if(s->len >= 8)
		{
			s->lu[s->len - 4] ^= poly[s->len][0];
			s->lu[s->len - 3] ^= poly[s->len][1];
			s->lu[s->len - 2] ^= poly[s->len][2];
			s->lu[s->len - 3] ^= poly[s->len][3];
			s->lu[s->len - 2] ^= poly[s->len][4];
		}
		s->lu[s->len - 1] ^= poly[s->len][5];
	}
	#endif

	/* Lu2 */
	memcpy(s->lu2, s->lu, s->len);

	msb = s->lu2[0] >> 7;

	for(i = 0; i < (s->len - 1); i++)
		s->lu2[i] = (s->lu2[i] << 1) | (s->lu2[i + 1] >> 7);

	s->lu2[i] <<= 1;

	#ifdef OMAC_SWITCH
	if(msb) poly(s->lu2, s->len);
	#else
	if(msb)
	{
		if(s->len >= 8)
		{
			s->lu2[s->len - 4] ^= poly[s->len][0];
			s->lu2[s->len - 3] ^= poly[s->len][1];
			s->lu2[s->len - 2] ^= poly[s->len][2];
			s->lu2[s->len - 3] ^= poly[s->len][3];
			s->lu2[s->len - 2] ^= poly[s->len][4];
		}
		s->lu2[s->len - 1] ^= poly[s->len][5];
	}
	#endif

	memset(s->prev, 0, s->len);
	s->i = 0;
	s->f = 0;
}

static void omac_input(kripto_mac *s, const void *in, size_t len)
{
	size_t i;

	for(i = 0; i < len; i++)
	{
		s->buf[s->i] = s->prev[s->i] ^ CU8(in)[i];
		s->i++;

		if(s->i == s->len)
		{
			kripto_block_encrypt(s->block, s->buf, s->prev);
			s->i = 0;
		}
	}
}

static void omac_tag(kripto_mac *s, void *tag, unsigned int len)
{
	unsigned int i;

	if(!s->f)
	{
		/* finish */
		if(s->i)
		{
			/* pad */
			s->buf[s->i] = 0x80 ^ s->prev[s->i];
			s->i++;
			while(s->i < s->len)
			{
				s->buf[s->i] = s->prev[s->i];
				s->i++;
			}

			/* Lu2 */
			for(i = 0; i < s->len; i++)
				s->buf[i] ^= s->lu2[i];
		}
		else
		{
			/* Lu */
			for(i = 0; i < s->len; i++)
				s->buf[i] ^= s->lu[i];
		}

		kripto_block_encrypt(s->block, s->buf, s->buf);
		s->i = 0;
		s->f = -1;
	}

	/* output */
	for(i = 0; i < len; i++)
	{
		assert(s->i < s->len);
		U8(tag)[i] = s->buf[s->i++];
	}
}

static void omac_destroy(kripto_mac *s)
{
	kripto_block_destroy(s->block);

	kripto_memwipe(s, sizeof(kripto_mac) + s->len * 4);
	free(s);
}

struct ext
{
	kripto_mac_desc desc;
	const kripto_block_desc *block;
};

#define EXT(X) ((const struct ext *)(X))

static kripto_mac *omac_create
(
	const kripto_mac_desc *desc,
	unsigned int r,
	const void *key,
	unsigned int key_len,
	unsigned int tag_len
)
{
	kripto_mac *s;

	(void)tag_len;

	s = malloc(sizeof(kripto_mac) + desc->maxtag * 4);
	if(!s) return 0;

	s->desc = desc;
	s->len = desc->maxtag;
	s->prev = (uint8_t *)s + sizeof(kripto_mac);
	s->buf = s->prev + s->len;
	s->lu = s->buf + s->len;
	s->lu2 = s->lu + s->len;
	s->block = kripto_block_create(EXT(desc)->block, r, key, key_len);
	if(!s->block)
	{
		free(s);
		return 0;
	}

	omac_init(s);

	return s;
}

static kripto_mac *omac_recreate
(
	kripto_mac *s,
	unsigned int r,
	const void *key,
	unsigned int key_len,
	unsigned int tag_len
)
{
	(void)tag_len;

	s->block = kripto_block_recreate(s->block, r, key, key_len);
	if(!s->block)
	{
		kripto_memwipe(s, sizeof(kripto_mac) + s->desc->maxtag * 4);
		free(s);
		return 0;
	}

	omac_init(s);

	return s;
}

kripto_mac_desc *kripto_mac_omac(const kripto_block_desc *block)
{
	struct ext *s;

	s = malloc(sizeof(struct ext));
	if(!s) return 0;

	s->block = block;

	s->desc.create = &omac_create;
	s->desc.recreate = &omac_recreate;
	s->desc.input = &omac_input;
	s->desc.tag = &omac_tag;
	s->desc.destroy = &omac_destroy;
	s->desc.maxtag = kripto_block_size(block);

	assert(s->desc.maxtag <= 255);

	return (kripto_mac_desc *)s;
}
