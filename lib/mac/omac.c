/*
 * Copyright (C) 2013 by Gregor Pintar <grpintar@gmail.com>
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */

#include <string.h>
#include <stdint.h>
#include <stdlib.h>
#include <assert.h>

#include <kripto/loadstore.h>
#include <kripto/memory.h>
#include <kripto/block.h>
#include <kripto/mac.h>
#include <kripto/desc/mac.h>

#include <kripto/mac/omac.h>

struct kripto_mac
{
	const kripto_desc_mac *desc;
	kripto_block *block;
	uint8_t *lu;
	uint8_t *lu2;
	uint8_t *buf;
	uint8_t *prev;
	unsigned int len;
	unsigned int i;
	int f;
};

/*
 * Table of Low-Weight Binary Irreducible Polynomials:
 * http://www.hpl.hp.com/techreports/98/HPL-98-135.pdf
 */
static const uint8_t poly[256][6] =
{
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, /*   0 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*   1 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2B}, /*   2 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*   3 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8D}, /*   4 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /*   5 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*   6 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x95}, /*   7 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*   8 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x09}, /*   9 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /*  10 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xC5}, /*  11 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x41}, /*  12 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  13 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /*  14 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  15 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}, /*  16 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  17 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x95}, /*  18 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x4D}, /*  19 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  20 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x0D}, /*  21 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /*  22 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x81}, /*  23 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}, /*  24 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  25 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x0B}, /*  26 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8B}, /*  27 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x09}, /*  28 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /*  29 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x29}, /*  30 */
	{0x00, 0x00, 0x00, 0x00, 0xC4, 0x01}, /*  31 */
	{0x00, 0x00, 0x00, 0x00, 0x04, 0x25}, /*  32 */
	{0x00, 0x00, 0x00, 0x00, 0x09, 0x45}, /*  33 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x0D}, /*  34 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /*  35 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x03}, /*  36 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8D}, /*  37 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x07}, /*  38 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x91}, /*  39 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  40 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0B}, /*  41 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x93}, /*  42 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}, /*  43 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x41}, /*  44 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  45 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8D}, /*  46 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0xA1}, /*  47 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0x0D}, /*  48 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x41}, /*  49 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  50 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /*  51 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /*  52 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x85}, /*  53 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x19}, /*  54 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  55 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x51}, /*  56 */
	{0x00, 0x00, 0x00, 0x04, 0x02, 0x41}, /*  57 */
	{0x00, 0x00, 0x00, 0x0C, 0x20, 0x01}, /*  58 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /*  59 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x41}, /*  60 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1B}, /*  61 */
	{0x00, 0x00, 0x00, 0x01, 0x00, 0x25}, /*  62 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x41}, /*  63 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x25}, /*  64 */
	{0x00, 0x00, 0x00, 0x00, 0x88, 0x05}, /*  65 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x45}, /*  66 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA9}, /*  67 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0B}, /*  68 */
	{0x00, 0x00, 0x00, 0x09, 0x02, 0x01}, /*  69 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x41}, /*  70 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0xC1}, /*  71 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x19}, /*  72 */
	{0x00, 0x00, 0x00, 0x00, 0x60, 0x09}, /*  73 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x49}, /*  74 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /*  75 */
	{0x00, 0x00, 0x00, 0x08, 0x20, 0x41}, /*  76 */
	{0x00, 0x00, 0x00, 0x08, 0x04, 0x09}, /*  77 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x61}, /*  78 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x07}, /*  79 */
	{0x00, 0x00, 0x00, 0x00, 0x40, 0x0D}, /*  80 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x0B}, /*  81 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xB1}, /*  82 */
	{0x00, 0x00, 0x00, 0x00, 0x0B, 0x01}, /*  83 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x61}, /*  84 */
	{0x00, 0x00, 0x00, 0x81, 0x02, 0x01}, /*  85 */
	{0x00, 0x00, 0x00, 0x08, 0x40, 0x41}, /*  86 */
	{0x00, 0x00, 0x00, 0x80, 0x04, 0x05}, /*  87 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /*  88 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /*  89 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x51}, /*  90 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1D}, /*  91 */
	{0x00, 0x00, 0x00, 0x00, 0x21, 0x41}, /*  92 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x03}, /*  93 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x09}, /*  94 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x61}, /*  95 */
	{0x00, 0x00, 0x00, 0x0A, 0x00, 0x11}, /*  96 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x81}, /*  97 */
	{0x00, 0x00, 0x00, 0x00, 0x22, 0x41}, /*  98 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x89}, /*  99 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x83}, /* 100 */
	{0x00, 0x00, 0x00, 0x00, 0x40, 0x0D}, /* 101 */
	{0x00, 0x00, 0x00, 0x00, 0x09, 0x05}, /* 102 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x51}, /* 103 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x25}, /* 104 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x23}, /* 105 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x13}, /* 106 */
	{0x00, 0x00, 0x00, 0x08, 0x04, 0x09}, /* 107 */
	{0x00, 0x00, 0x00, 0x20, 0x04, 0x41}, /* 108 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x0B}, /* 109 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0xA1}, /* 110 */
	{0x00, 0x00, 0x00, 0x0C, 0x04, 0x01}, /* 111 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA9}, /* 112 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0x85}, /* 113 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA3}, /* 114 */
	{0x00, 0x00, 0x00, 0x00, 0x42, 0x41}, /* 115 */
	{0x00, 0x00, 0x00, 0x00, 0x04, 0x0D}, /* 116 */
	{0x00, 0x00, 0x00, 0x00, 0xB0, 0x01}, /* 117 */
	{0x00, 0x00, 0x00, 0x00, 0x1A, 0x01}, /* 118 */
	{0x00, 0x00, 0x00, 0x01, 0x02, 0x81}, /* 119 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x09}, /* 120 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x25}, /* 121 */
	{0x00, 0x00, 0x00, 0x02, 0x04, 0x41}, /* 122 */
	{0x00, 0x00, 0x01, 0x00, 0x02, 0x09}, /* 123 */
	{0x00, 0x00, 0x00, 0x02, 0xA0, 0x01}, /* 124 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /* 125 */
	{0x00, 0x00, 0x00, 0x0A, 0x01, 0x01}, /* 126 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x49}, /* 127 */
	{0x00, 0x00, 0x00, 0x08, 0x00, 0x43}, /* 128 */
	{0x00, 0x00, 0x00, 0x20, 0x80, 0x09}, /* 129 */
	{0x00, 0x00, 0x00, 0x00, 0x85, 0x01}, /* 130 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x85}, /* 131 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x07}, /* 132 */
	{0x00, 0x00, 0x00, 0x00, 0x2A, 0x01}, /* 133 */
	{0x00, 0x00, 0x00, 0x08, 0x03, 0x01}, /* 134 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x41}, /* 135 */
	{0x00, 0x00, 0x00, 0x60, 0x04, 0x01}, /* 136 */
	{0x00, 0x00, 0x01, 0x00, 0x80, 0x41}, /* 137 */
	{0x00, 0x00, 0x00, 0x20, 0x02, 0x41}, /* 138 */
	{0x00, 0x00, 0x00, 0x00, 0x81, 0x41}, /* 139 */
	{0x00, 0x00, 0x00, 0x00, 0x22, 0x41}, /* 140 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x8B}, /* 141 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /* 142 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x81}, /* 143 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x0D}, /* 144 */
	{0x00, 0x00, 0x00, 0x00, 0x88, 0x05}, /* 145 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0x85}, /* 146 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x09}, /* 147 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /* 148 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x81}, /* 149 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x41}, /* 150 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x41}, /* 151 */
	{0x00, 0x00, 0x0A, 0x00, 0x02, 0x01}, /* 152 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x81}, /* 153 */
	{0x00, 0x00, 0x02, 0x00, 0x04, 0x05}, /* 154 */
	{0x00, 0x00, 0x00, 0x02, 0x00, 0xA1}, /* 155 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x29}, /* 156 */
	{0x00, 0x00, 0xC0, 0x00, 0x00, 0x05}, /* 157 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /* 158 */
	{0x00, 0x00, 0x00, 0x01, 0x02, 0x81}, /* 159 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0xA1}, /* 160 */
	{0x00, 0x00, 0x00, 0x81, 0x00, 0x41}, /* 161 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x05}, /* 162 */
	{0x00, 0x00, 0x00, 0x12, 0x80, 0x01}, /* 163 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x05}, /* 164 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x09}, /* 165 */
	{0x00, 0x00, 0x00, 0x20, 0x08, 0x09}, /* 166 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /* 167 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x43}, /* 168 */
	{0x00, 0x00, 0x00, 0x02, 0x40, 0x41}, /* 169 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x2D}, /* 170 */
	{0x00, 0x00, 0x00, 0x00, 0x82, 0x21}, /* 171 */
	{0x00, 0x00, 0x00, 0x0C, 0x04, 0x01}, /* 172 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x23}, /* 173 */
	{0x00, 0x00, 0x00, 0x02, 0x80, 0x21}, /* 174 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0B}, /* 175 */
	{0x00, 0x00, 0x00, 0x00, 0x60, 0x41}, /* 176 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x41}, /* 177 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x45}, /* 178 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x41}, /* 179 */
	{0x00, 0x00, 0x00, 0x00, 0x60, 0x81}, /* 180 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /* 181 */
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x15}, /* 182 */
	{0x00, 0x00, 0x00, 0x00, 0x12, 0x09}, /* 183 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x13}, /* 184 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x05}, /* 185 */
	{0x00, 0x00, 0x00, 0x00, 0x03, 0x41}, /* 186 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x11}, /* 187 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /* 188 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x09}, /* 189 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x09}, /* 190 */
	{0x00, 0x00, 0x00, 0x06, 0x00, 0x81}, /* 191 */
	{0x00, 0x00, 0x00, 0x20, 0x00, 0x45}, /* 192 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x83}, /* 193 */
	{0x00, 0x00, 0x00, 0x08, 0x10, 0x05}, /* 194 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x25}, /* 195 */
	{0x00, 0x00, 0x00, 0x20, 0x04, 0x81}, /* 196 */
	{0x00, 0x00, 0x00, 0x10, 0x02, 0x05}, /* 197 */
	{0x00, 0x00, 0x00, 0x28, 0x20, 0x01}, /* 198 */
	{0x00, 0x00, 0x00, 0x00, 0x10, 0xA1}, /* 199 */
	{0x00, 0x00, 0x00, 0x00, 0x48, 0x03}, /* 200 */
	{0x00, 0x00, 0x00, 0x00, 0xA0, 0x03}, /* 201 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x19}, /* 202 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x21}, /* 203 */
	{0x00, 0x00, 0x00, 0x02, 0x80, 0x09}, /* 204 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA3}, /* 205 */
	{0x00, 0x00, 0x00, 0x04, 0x20, 0x03}, /* 206 */
	{0x00, 0x00, 0x00, 0x08, 0x81, 0x01}, /* 207 */
	{0x00, 0x00, 0x00, 0x02, 0x02, 0x41}, /* 208 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x39}, /* 209 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x45}, /* 210 */
	{0x00, 0x00, 0x00, 0x00, 0x81, 0x41}, /* 211 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x49}, /* 212 */
	{0x00, 0x00, 0x00, 0x00, 0x48, 0x09}, /* 213 */
	{0x00, 0x00, 0x00, 0x00, 0x90, 0x21}, /* 214 */
	{0x00, 0x00, 0x00, 0x02, 0x44, 0x01}, /* 215 */
	{0x00, 0x00, 0x00, 0x00, 0x0C, 0x21}, /* 216 */
	{0x00, 0x00, 0x00, 0x08, 0x40, 0x41}, /* 217 */
	{0x00, 0x00, 0x00, 0x0C, 0x00, 0x05}, /* 218 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x4D}, /* 219 */
	{0x00, 0x00, 0x00, 0x00, 0x01, 0x0D}, /* 220 */
	{0x00, 0x00, 0x02, 0x00, 0x00, 0x61}, /* 221 */
	{0x00, 0x00, 0x00, 0x00, 0x06, 0x09}, /* 222 */
	{0x00, 0x00, 0x00, 0xA0, 0x00, 0x41}, /* 223 */
	{0x00, 0x00, 0x00, 0x02, 0x40, 0x09}, /* 224 */
	{0x00, 0x00, 0x00, 0x40, 0x00, 0x25}, /* 225 */
	{0x00, 0x00, 0x00, 0x09, 0x02, 0x01}, /* 226 */
	{0x00, 0x00, 0x00, 0x84, 0x00, 0x03}, /* 227 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xA3}, /* 228 */
	{0x00, 0x00, 0x00, 0x04, 0x20, 0x81}, /* 229 */
	{0x00, 0x00, 0x00, 0x20, 0x04, 0x05}, /* 230 */
	{0x00, 0x00, 0x00, 0x01, 0x20, 0x09}, /* 231 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x11}, /* 232 */
	{0x00, 0x00, 0x00, 0x00, 0x0A, 0x03}, /* 233 */
	{0x00, 0x00, 0x00, 0x00, 0x04, 0x25}, /* 234 */
	{0x00, 0x00, 0x00, 0x00, 0x80, 0x15}, /* 235 */
	{0x00, 0x00, 0x00, 0x02, 0x20, 0x05}, /* 236 */
	{0x00, 0x00, 0x04, 0x00, 0x08, 0x05}, /* 237 */
	{0x00, 0x00, 0x00, 0x00, 0x18, 0x03}, /* 238 */
	{0x00, 0x00, 0x00, 0x10, 0x84, 0x01}, /* 239 */
	{0x00, 0x00, 0x00, 0x00, 0x08, 0x0D}, /* 240 */
	{0x00, 0x00, 0x00, 0x03, 0x00, 0x81}, /* 241 */
	{0x00, 0x00, 0x00, 0x00, 0x84, 0x03}, /* 242 */
	{0x00, 0x00, 0x08, 0x44, 0x00, 0x01}, /* 243 */
	{0x00, 0x00, 0x00, 0x00, 0xC0, 0x41}, /* 244 */
	{0x00, 0x00, 0x00, 0x02, 0x80, 0x05}, /* 245 */
	{0x00, 0x00, 0x02, 0x08, 0x40, 0x01}, /* 246 */
	{0x00, 0x00, 0x02, 0x0A, 0x00, 0x01}, /* 247 */
	{0x00, 0x00, 0x00, 0x00, 0x28, 0x21}, /* 248 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x4D}, /* 249 */
	{0x00, 0x00, 0x00, 0x00, 0x24, 0x41}, /* 250 */
	{0x00, 0x00, 0x04, 0x80, 0x20, 0x01}, /* 251 */
	{0x00, 0x00, 0x00, 0x20, 0x80, 0x81}, /* 252 */
	{0x01, 0x08, 0x00, 0x00, 0x02, 0x01}, /* 253 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0xC5}, /* 254 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x87}  /* 255 */
};

static void omac_init(kripto_mac *s)
{
	unsigned int i;
	uint8_t msb;

	memset(s->lu, 0, s->len);
	kripto_block_encrypt(s->block, s->lu, s->lu);

	/* Lu */
	msb = s->lu[0] >> 7;

	for(i = 0; i < (s->len - 1); i++)
		s->lu[i] = (s->lu[i] << 1) | (s->lu[i + 1] >> 7);

	s->lu[i] <<= 1;

	if(msb)
	{
		if(s->len >= 8)
		{
			s->lu[s->len - 4] ^= poly[s->len][0];
			s->lu[s->len - 3] ^= poly[s->len][1];
			s->lu[s->len - 2] ^= poly[s->len][2];
			s->lu[s->len - 3] ^= poly[s->len][3];
			s->lu[s->len - 2] ^= poly[s->len][4];
		}
		s->lu[s->len - 1] ^= poly[s->len][5];
	}

	/* Lu2 */
	memcpy(s->lu2, s->lu, s->len);

	msb = s->lu2[0] >> 7;

	for(i = 0; i < (s->len - 1); i++)
		s->lu2[i] = (s->lu2[i] << 1) | (s->lu2[i + 1] >> 7);

	s->lu2[i] <<= 1;

	if(msb)
	{
		if(s->len >= 8)
		{
			s->lu2[s->len - 4] ^= poly[s->len][0];
			s->lu2[s->len - 3] ^= poly[s->len][1];
			s->lu2[s->len - 2] ^= poly[s->len][2];
			s->lu2[s->len - 3] ^= poly[s->len][3];
			s->lu2[s->len - 2] ^= poly[s->len][4];
		}
		s->lu2[s->len - 1] ^= poly[s->len][5];
	}

	memset(s->prev, 0, s->len);
	s->i = 0;
	s->f = 0;
}

static void omac_input(kripto_mac *s, const void *in, size_t len)
{
	size_t i;

	for(i = 0; i < len; i++)
	{
		if(s->i == s->len)
		{
			kripto_block_encrypt(s->block, s->buf, s->prev);
			s->i = 0;
		}

		s->buf[s->i] = s->prev[s->i] ^ CU8(in)[i];
		s->i++;
	}
}

static void omac_tag(kripto_mac *s, void *tag, unsigned int len)
{
	unsigned int i;

	if(!s->f)
	{
		/* finish */
		if(s->i == s->len)
		{
			/* Lu */
			for(i = 0; i < s->len; i++)
				s->buf[i] ^= s->lu[i];
		}
		else
		{
			/* pad */
			s->buf[s->i] = 0x80 ^ s->prev[s->i];
			s->i++;
			while(s->i < s->len)
			{
				s->buf[s->i] = s->prev[s->i];
				s->i++;
			}

			/* Lu2 */
			for(i = 0; i < s->len; i++)
				s->buf[i] ^= s->lu2[i];
		}

		kripto_block_encrypt(s->block, s->buf, s->buf);
		s->i = 0;
		s->f = -1;
	}

	/* output */
	assert(s->i + len <= s->len);
	for(i = 0; i < len; i++)
	{
		U8(tag)[i] = s->buf[s->i++];
	}
}

static void omac_destroy(kripto_mac *s)
{
	kripto_block_destroy(s->block);

	kripto_memory_wipe(s, sizeof(kripto_mac) + s->len * 4);
	free(s);
}

struct ext
{
	kripto_desc_mac desc;
	const kripto_desc_block *block;
};

#define EXT(X) ((const struct ext *)(X))

static kripto_mac *omac_create
(
	const kripto_desc_mac *desc,
	unsigned int r,
	const void *key,
	unsigned int key_len,
	unsigned int tag_len
)
{
	kripto_mac *s = (kripto_mac *)malloc(sizeof(kripto_mac) + desc->maxtag * 4);
	if(!s) return 0;

	(void)tag_len;

	s->desc = desc;
	s->len = desc->maxtag;
	s->prev = (uint8_t *)s + sizeof(kripto_mac);
	s->buf = s->prev + s->len;
	s->lu = s->buf + s->len;
	s->lu2 = s->lu + s->len;
	s->block = kripto_block_create(EXT(desc)->block, r, key, key_len);
	if(!s->block)
	{
		free(s);
		return 0;
	}

	omac_init(s);

	return s;
}

static kripto_mac *omac_recreate
(
	kripto_mac *s,
	unsigned int r,
	const void *key,
	unsigned int key_len,
	unsigned int tag_len
)
{
	(void)tag_len;

	s->block = kripto_block_recreate(s->block, r, key, key_len);
	if(!s->block)
	{
		kripto_memory_wipe(s, sizeof(kripto_mac) + s->desc->maxtag * 4);
		free(s);
		return 0;
	}

	omac_init(s);

	return s;
}

kripto_desc_mac *kripto_mac_omac(const kripto_desc_block *block)
{
	struct ext *s = (struct ext *)malloc(sizeof(struct ext));
	if(!s) return 0;

	s->block = block;

	s->desc.create = &omac_create;
	s->desc.recreate = &omac_recreate;
	s->desc.input = &omac_input;
	s->desc.tag = &omac_tag;
	s->desc.destroy = &omac_destroy;
	s->desc.maxtag = kripto_block_size(block);
	s->desc.maxkey = kripto_block_maxkey(block);

	assert(s->desc.maxtag <= 255);

	return (kripto_desc_mac *)s;
}
