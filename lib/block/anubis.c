/*
 * Copyright (C) 2011 Gregor Pintar <grpintar@gmail.com>
 *
 * Permission is granted to deal in this work without any restriction,
 * including unlimited rights to use, publicly perform, publish,
 * reproduce, relicence, modify, merge, and/or distribute in any form,
 * for any purpose, with or without fee, and by any means.
 *
 * This work is provided "AS IS" and WITHOUT WARRANTY of any kind,
 * to the utmost extent permitted by applicable law. In no event
 * shall a licensor, author or contributor be held liable for any
 * issues arising in any way out of dealing in the work.
 */

/*
 * Anubis tweak implementation derived from Paulo S.L.M. Barreto
 * and Vincent Rijmen public domain source.
 */

#include <stdint.h>
#include <stdlib.h>

#include <kripto/cast.h>
#include <kripto/loadstore.h>
#include <kripto/memwipe.h>
#include <kripto/block.h>
#include <kripto/desc/block.h>
#include <kripto/object/block.h>

#include <kripto/block/anubis.h>

struct kripto_block
{
	struct kripto_block_object obj;
	unsigned int rounds;
	size_t size;
	uint32_t *k;
	uint32_t *dk;
};

static const uint32_t s0[256] =
{
	0xBA69D2BB, 0x54A84DE5, 0x2F5EBCE2, 0x74E8CD25,
	0x53A651F7, 0xD3BB6BD0, 0xD2B96FD6, 0x4D9A29B3,
	0x50A05DFD, 0xAC458ACF, 0x8D070E09, 0xBF63C6A5,
	0x70E0DD3D, 0x52A455F1, 0x9A29527B, 0x4C982DB5,
	0xEAC98F46, 0xD5B773C4, 0x97336655, 0xD1BF63DC,
	0x3366CCAA, 0x51A259FB, 0x5BB671C7, 0xA651A2F3,
	0xDEA15FFE, 0x48903DAD, 0xA84D9AD7, 0x992F5E71,
	0xDBAB4BE0, 0x3264C8AC, 0xB773E695, 0xFCE5D732,
	0xE3DBAB70, 0x9E214263, 0x913F7E41, 0x9B2B567D,
	0xE2D9AF76, 0xBB6BD6BD, 0x4182199B, 0x6EDCA579,
	0xA557AEF9, 0xCB8B0B80, 0x6BD6B167, 0x95376E59,
	0xA15FBEE1, 0xF3FBEB10, 0xB17FFE81, 0x0204080C,
	0xCC851792, 0xC49537A2, 0x1D3A744E, 0x14285078,
	0xC39B2BB0, 0x63C69157, 0xDAA94FE6, 0x5DBA69D3,
	0x5FBE61DF, 0xDCA557F2, 0x7DFAE913, 0xCD871394,
	0x7FFEE11F, 0x5AB475C1, 0x6CD8AD75, 0x5CB86DD5,
	0xF7F3FB08, 0x264C98D4, 0xFFE3DB38, 0xEDC79354,
	0xE8CD874A, 0x9D274E69, 0x6FDEA17F, 0x8E010203,
	0x19326456, 0xA05DBAE7, 0xF0FDE71A, 0x890F1E11,
	0x0F1E3C22, 0x070E1C12, 0xAF4386C5, 0xFBEBCB20,
	0x08102030, 0x152A547E, 0x0D1A342E, 0x04081018,
	0x01020406, 0x64C88D45, 0xDFA35BF8, 0x76ECC529,
	0x79F2F90B, 0xDDA753F4, 0x3D7AF48E, 0x162C5874,
	0x3F7EFC82, 0x376EDCB2, 0x6DDAA973, 0x3870E090,
	0xB96FDEB1, 0x73E6D137, 0xE9CF834C, 0x356AD4BE,
	0x55AA49E3, 0x71E2D93B, 0x7BF6F107, 0x8C050A0F,
	0x72E4D531, 0x880D1A17, 0xF6F1FF0E, 0x2A54A8FC,
	0x3E7CF884, 0x5EBC65D9, 0x274E9CD2, 0x468C0589,
	0x0C183028, 0x65CA8943, 0x68D0BD6D, 0x61C2995B,
	0x03060C0A, 0xC19F23BC, 0x57AE41EF, 0xD6B17FCE,
	0xD9AF43EC, 0x58B07DCD, 0xD8AD47EA, 0x66CC8549,
	0xD7B37BC8, 0x3A74E89C, 0xC88D078A, 0x3C78F088,
	0xFAE9CF26, 0x96316253, 0xA753A6F5, 0x982D5A77,
	0xECC59752, 0xB86DDAB7, 0xC7933BA8, 0xAE4182C3,
	0x69D2B96B, 0x4B9631A7, 0xAB4B96DD, 0xA94F9ED1,
	0x67CE814F, 0x0A14283C, 0x478E018F, 0xF2F9EF16,
	0xB577EE99, 0x224488CC, 0xE5D7B364, 0xEEC19F5E,
	0xBE61C2A3, 0x2B56ACFA, 0x811F3E21, 0x1224486C,
	0x831B362D, 0x1B366C5A, 0x0E1C3824, 0x23468CCA,
	0xF5F7F304, 0x458A0983, 0x214284C6, 0xCE811F9E,
	0x499239AB, 0x2C58B0E8, 0xF9EFC32C, 0xE6D1BF6E,
	0xB671E293, 0x2850A0F0, 0x172E5C72, 0x8219322B,
	0x1A34685C, 0x8B0B161D, 0xFEE1DF3E, 0x8A09121B,
	0x09122436, 0xC98F038C, 0x87132635, 0x4E9C25B9,
	0xE1DFA37C, 0x2E5CB8E4, 0xE4D5B762, 0xE0DDA77A,
	0xEBCB8B40, 0x903D7A47, 0xA455AAFF, 0x1E3C7844,
	0x85172E39, 0x60C09D5D, 0x00000000, 0x254A94DE,
	0xF4F5F702, 0xF1FFE31C, 0x94356A5F, 0x0B162C3A,
	0xE7D3BB68, 0x75EAC923, 0xEFC39B58, 0x3468D0B8,
	0x3162C4A6, 0xD4B577C2, 0xD0BD67DA, 0x86112233,
	0x7EFCE519, 0xAD478EC9, 0xFDE7D334, 0x2952A4F6,
	0x3060C0A0, 0x3B76EC9A, 0x9F234665, 0xF8EDC72A,
	0xC6913FAE, 0x13264C6A, 0x060C1814, 0x050A141E,
	0xC59733A4, 0x11224466, 0x77EEC12F, 0x7CF8ED15,
	0x7AF4F501, 0x78F0FD0D, 0x366CD8B4, 0x1C387048,
	0x3972E496, 0x59B279CB, 0x18306050, 0x56AC45E9,
	0xB37BF68D, 0xB07DFA87, 0x244890D8, 0x204080C0,
	0xB279F28B, 0x9239724B, 0xA35BB6ED, 0xC09D27BA,
	0x44880D85, 0x62C49551, 0x10204060, 0xB475EA9F,
	0x84152A3F, 0x43861197, 0x933B764D, 0xC2992FB6,
	0x4A9435A1, 0xBD67CEA9, 0x8F030605, 0x2D5AB4EE,
	0xBC65CAAF, 0x9C254A6F, 0x6AD4B561, 0x40801D9D,
	0xCF831B98, 0xA259B2EB, 0x801D3A27, 0x4F9E21BF,
	0x1F3E7C42, 0xCA890F86, 0xAA4992DB, 0x42841591
};

static const uint32_t s1[256] =
{
	0x69BABBD2, 0xA854E54D, 0x5E2FE2BC, 0xE87425CD,
	0xA653F751, 0xBBD3D06B, 0xB9D2D66F, 0x9A4DB329,
	0xA050FD5D, 0x45ACCF8A, 0x078D090E, 0x63BFA5C6,
	0xE0703DDD, 0xA452F155, 0x299A7B52, 0x984CB52D,
	0xC9EA468F, 0xB7D5C473, 0x33975566, 0xBFD1DC63,
	0x6633AACC, 0xA251FB59, 0xB65BC771, 0x51A6F3A2,
	0xA1DEFE5F, 0x9048AD3D, 0x4DA8D79A, 0x2F99715E,
	0xABDBE04B, 0x6432ACC8, 0x73B795E6, 0xE5FC32D7,
	0xDBE370AB, 0x219E6342, 0x3F91417E, 0x2B9B7D56,
	0xD9E276AF, 0x6BBBBDD6, 0x82419B19, 0xDC6E79A5,
	0x57A5F9AE, 0x8BCB800B, 0xD66B67B1, 0x3795596E,
	0x5FA1E1BE, 0xFBF310EB, 0x7FB181FE, 0x04020C08,
	0x85CC9217, 0x95C4A237, 0x3A1D4E74, 0x28147850,
	0x9BC3B02B, 0xC6635791, 0xA9DAE64F, 0xBA5DD369,
	0xBE5FDF61, 0xA5DCF257, 0xFA7D13E9, 0x87CD9413,
	0xFE7F1FE1, 0xB45AC175, 0xD86C75AD, 0xB85CD56D,
	0xF3F708FB, 0x4C26D498, 0xE3FF38DB, 0xC7ED5493,
	0xCDE84A87, 0x279D694E, 0xDE6F7FA1, 0x018E0302,
	0x32195664, 0x5DA0E7BA, 0xFDF01AE7, 0x0F89111E,
	0x1E0F223C, 0x0E07121C, 0x43AFC586, 0xEBFB20CB,
	0x10083020, 0x2A157E54, 0x1A0D2E34, 0x08041810,
	0x02010604, 0xC864458D, 0xA3DFF85B, 0xEC7629C5,
	0xF2790BF9, 0xA7DDF453, 0x7A3D8EF4, 0x2C167458,
	0x7E3F82FC, 0x6E37B2DC, 0xDA6D73A9, 0x703890E0,
	0x6FB9B1DE, 0xE67337D1, 0xCFE94C83, 0x6A35BED4,
	0xAA55E349, 0xE2713BD9, 0xF67B07F1, 0x058C0F0A,
	0xE47231D5, 0x0D88171A, 0xF1F60EFF, 0x542AFCA8,
	0x7C3E84F8, 0xBC5ED965, 0x4E27D29C, 0x8C468905,
	0x180C2830, 0xCA654389, 0xD0686DBD, 0xC2615B99,
	0x06030A0C, 0x9FC1BC23, 0xAE57EF41, 0xB1D6CE7F,
	0xAFD9EC43, 0xB058CD7D, 0xADD8EA47, 0xCC664985,
	0xB3D7C87B, 0x743A9CE8, 0x8DC88A07, 0x783C88F0,
	0xE9FA26CF, 0x31965362, 0x53A7F5A6, 0x2D98775A,
	0xC5EC5297, 0x6DB8B7DA, 0x93C7A83B, 0x41AEC382,
	0xD2696BB9, 0x964BA731, 0x4BABDD96, 0x4FA9D19E,
	0xCE674F81, 0x140A3C28, 0x8E478F01, 0xF9F216EF,
	0x77B599EE, 0x4422CC88, 0xD7E564B3, 0xC1EE5E9F,
	0x61BEA3C2, 0x562BFAAC, 0x1F81213E, 0x24126C48,
	0x1B832D36, 0x361B5A6C, 0x1C0E2438, 0x4623CA8C,
	0xF7F504F3, 0x8A458309, 0x4221C684, 0x81CE9E1F,
	0x9249AB39, 0x582CE8B0, 0xEFF92CC3, 0xD1E66EBF,
	0x71B693E2, 0x5028F0A0, 0x2E17725C, 0x19822B32,
	0x341A5C68, 0x0B8B1D16, 0xE1FE3EDF, 0x098A1B12,
	0x12093624, 0x8FC98C03, 0x13873526, 0x9C4EB925,
	0xDFE17CA3, 0x5C2EE4B8, 0xD5E462B7, 0xDDE07AA7,
	0xCBEB408B, 0x3D90477A, 0x55A4FFAA, 0x3C1E4478,
	0x1785392E, 0xC0605D9D, 0x00000000, 0x4A25DE94,
	0xF5F402F7, 0xFFF11CE3, 0x35945F6A, 0x160B3A2C,
	0xD3E768BB, 0xEA7523C9, 0xC3EF589B, 0x6834B8D0,
	0x6231A6C4, 0xB5D4C277, 0xBDD0DA67, 0x11863322,
	0xFC7E19E5, 0x47ADC98E, 0xE7FD34D3, 0x5229F6A4,
	0x6030A0C0, 0x763B9AEC, 0x239F6546, 0xEDF82AC7,
	0x91C6AE3F, 0x26136A4C, 0x0C061418, 0x0A051E14,
	0x97C5A433, 0x22116644, 0xEE772FC1, 0xF87C15ED,
	0xF47A01F5, 0xF0780DFD, 0x6C36B4D8, 0x381C4870,
	0x723996E4, 0xB259CB79, 0x30185060, 0xAC56E945,
	0x7BB38DF6, 0x7DB087FA, 0x4824D890, 0x4020C080,
	0x79B28BF2, 0x39924B72, 0x5BA3EDB6, 0x9DC0BA27,
	0x8844850D, 0xC4625195, 0x20106040, 0x75B49FEA,
	0x15843F2A, 0x86439711, 0x3B934D76, 0x99C2B62F,
	0x944AA135, 0x67BDA9CE, 0x038F0506, 0x5A2DEEB4,
	0x65BCAFCA, 0x259C6F4A, 0xD46A61B5, 0x80409D1D,
	0x83CF981B, 0x59A2EBB2, 0x1D80273A, 0x9E4FBF21,
	0x3E1F427C, 0x89CA860F, 0x49AADB92, 0x84429115
};

static const uint32_t s2[256] =
{
	0xD2BBBA69, 0x4DE554A8, 0xBCE22F5E, 0xCD2574E8,
	0x51F753A6, 0x6BD0D3BB, 0x6FD6D2B9, 0x29B34D9A,
	0x5DFD50A0, 0x8ACFAC45, 0x0E098D07, 0xC6A5BF63,
	0xDD3D70E0, 0x55F152A4, 0x527B9A29, 0x2DB54C98,
	0x8F46EAC9, 0x73C4D5B7, 0x66559733, 0x63DCD1BF,
	0xCCAA3366, 0x59FB51A2, 0x71C75BB6, 0xA2F3A651,
	0x5FFEDEA1, 0x3DAD4890, 0x9AD7A84D, 0x5E71992F,
	0x4BE0DBAB, 0xC8AC3264, 0xE695B773, 0xD732FCE5,
	0xAB70E3DB, 0x42639E21, 0x7E41913F, 0x567D9B2B,
	0xAF76E2D9, 0xD6BDBB6B, 0x199B4182, 0xA5796EDC,
	0xAEF9A557, 0x0B80CB8B, 0xB1676BD6, 0x6E599537,
	0xBEE1A15F, 0xEB10F3FB, 0xFE81B17F, 0x080C0204,
	0x1792CC85, 0x37A2C495, 0x744E1D3A, 0x50781428,
	0x2BB0C39B, 0x915763C6, 0x4FE6DAA9, 0x69D35DBA,
	0x61DF5FBE, 0x57F2DCA5, 0xE9137DFA, 0x1394CD87,
	0xE11F7FFE, 0x75C15AB4, 0xAD756CD8, 0x6DD55CB8,
	0xFB08F7F3, 0x98D4264C, 0xDB38FFE3, 0x9354EDC7,
	0x874AE8CD, 0x4E699D27, 0xA17F6FDE, 0x02038E01,
	0x64561932, 0xBAE7A05D, 0xE71AF0FD, 0x1E11890F,
	0x3C220F1E, 0x1C12070E, 0x86C5AF43, 0xCB20FBEB,
	0x20300810, 0x547E152A, 0x342E0D1A, 0x10180408,
	0x04060102, 0x8D4564C8, 0x5BF8DFA3, 0xC52976EC,
	0xF90B79F2, 0x53F4DDA7, 0xF48E3D7A, 0x5874162C,
	0xFC823F7E, 0xDCB2376E, 0xA9736DDA, 0xE0903870,
	0xDEB1B96F, 0xD13773E6, 0x834CE9CF, 0xD4BE356A,
	0x49E355AA, 0xD93B71E2, 0xF1077BF6, 0x0A0F8C05,
	0xD53172E4, 0x1A17880D, 0xFF0EF6F1, 0xA8FC2A54,
	0xF8843E7C, 0x65D95EBC, 0x9CD2274E, 0x0589468C,
	0x30280C18, 0x894365CA, 0xBD6D68D0, 0x995B61C2,
	0x0C0A0306, 0x23BCC19F, 0x41EF57AE, 0x7FCED6B1,
	0x43ECD9AF, 0x7DCD58B0, 0x47EAD8AD, 0x854966CC,
	0x7BC8D7B3, 0xE89C3A74, 0x078AC88D, 0xF0883C78,
	0xCF26FAE9, 0x62539631, 0xA6F5A753, 0x5A77982D,
	0x9752ECC5, 0xDAB7B86D, 0x3BA8C793, 0x82C3AE41,
	0xB96B69D2, 0x31A74B96, 0x96DDAB4B, 0x9ED1A94F,
	0x814F67CE, 0x283C0A14, 0x018F478E, 0xEF16F2F9,
	0xEE99B577, 0x88CC2244, 0xB364E5D7, 0x9F5EEEC1,
	0xC2A3BE61, 0xACFA2B56, 0x3E21811F, 0x486C1224,
	0x362D831B, 0x6C5A1B36, 0x38240E1C, 0x8CCA2346,
	0xF304F5F7, 0x0983458A, 0x84C62142, 0x1F9ECE81,
	0x39AB4992, 0xB0E82C58, 0xC32CF9EF, 0xBF6EE6D1,
	0xE293B671, 0xA0F02850, 0x5C72172E, 0x322B8219,
	0x685C1A34, 0x161D8B0B, 0xDF3EFEE1, 0x121B8A09,
	0x24360912, 0x038CC98F, 0x26358713, 0x25B94E9C,
	0xA37CE1DF, 0xB8E42E5C, 0xB762E4D5, 0xA77AE0DD,
	0x8B40EBCB, 0x7A47903D, 0xAAFFA455, 0x78441E3C,
	0x2E398517, 0x9D5D60C0, 0x00000000, 0x94DE254A,
	0xF702F4F5, 0xE31CF1FF, 0x6A5F9435, 0x2C3A0B16,
	0xBB68E7D3, 0xC92375EA, 0x9B58EFC3, 0xD0B83468,
	0xC4A63162, 0x77C2D4B5, 0x67DAD0BD, 0x22338611,
	0xE5197EFC, 0x8EC9AD47, 0xD334FDE7, 0xA4F62952,
	0xC0A03060, 0xEC9A3B76, 0x46659F23, 0xC72AF8ED,
	0x3FAEC691, 0x4C6A1326, 0x1814060C, 0x141E050A,
	0x33A4C597, 0x44661122, 0xC12F77EE, 0xED157CF8,
	0xF5017AF4, 0xFD0D78F0, 0xD8B4366C, 0x70481C38,
	0xE4963972, 0x79CB59B2, 0x60501830, 0x45E956AC,
	0xF68DB37B, 0xFA87B07D, 0x90D82448, 0x80C02040,
	0xF28BB279, 0x724B9239, 0xB6EDA35B, 0x27BAC09D,
	0x0D854488, 0x955162C4, 0x40601020, 0xEA9FB475,
	0x2A3F8415, 0x11974386, 0x764D933B, 0x2FB6C299,
	0x35A14A94, 0xCEA9BD67, 0x06058F03, 0xB4EE2D5A,
	0xCAAFBC65, 0x4A6F9C25, 0xB5616AD4, 0x1D9D4080,
	0x1B98CF83, 0xB2EBA259, 0x3A27801D, 0x21BF4F9E,
	0x7C421F3E, 0x0F86CA89, 0x92DBAA49, 0x15914284
};

static const uint32_t s3[256] =
{
	0xBBD269BA, 0xE54DA854, 0xE2BC5E2F, 0x25CDE874,
	0xF751A653, 0xD06BBBD3, 0xD66FB9D2, 0xB3299A4D,
	0xFD5DA050, 0xCF8A45AC, 0x090E078D, 0xA5C663BF,
	0x3DDDE070, 0xF155A452, 0x7B52299A, 0xB52D984C,
	0x468FC9EA, 0xC473B7D5, 0x55663397, 0xDC63BFD1,
	0xAACC6633, 0xFB59A251, 0xC771B65B, 0xF3A251A6,
	0xFE5FA1DE, 0xAD3D9048, 0xD79A4DA8, 0x715E2F99,
	0xE04BABDB, 0xACC86432, 0x95E673B7, 0x32D7E5FC,
	0x70ABDBE3, 0x6342219E, 0x417E3F91, 0x7D562B9B,
	0x76AFD9E2, 0xBDD66BBB, 0x9B198241, 0x79A5DC6E,
	0xF9AE57A5, 0x800B8BCB, 0x67B1D66B, 0x596E3795,
	0xE1BE5FA1, 0x10EBFBF3, 0x81FE7FB1, 0x0C080402,
	0x921785CC, 0xA23795C4, 0x4E743A1D, 0x78502814,
	0xB02B9BC3, 0x5791C663, 0xE64FA9DA, 0xD369BA5D,
	0xDF61BE5F, 0xF257A5DC, 0x13E9FA7D, 0x941387CD,
	0x1FE1FE7F, 0xC175B45A, 0x75ADD86C, 0xD56DB85C,
	0x08FBF3F7, 0xD4984C26, 0x38DBE3FF, 0x5493C7ED,
	0x4A87CDE8, 0x694E279D, 0x7FA1DE6F, 0x0302018E,
	0x56643219, 0xE7BA5DA0, 0x1AE7FDF0, 0x111E0F89,
	0x223C1E0F, 0x121C0E07, 0xC58643AF, 0x20CBEBFB,
	0x30201008, 0x7E542A15, 0x2E341A0D, 0x18100804,
	0x06040201, 0x458DC864, 0xF85BA3DF, 0x29C5EC76,
	0x0BF9F279, 0xF453A7DD, 0x8EF47A3D, 0x74582C16,
	0x82FC7E3F, 0xB2DC6E37, 0x73A9DA6D, 0x90E07038,
	0xB1DE6FB9, 0x37D1E673, 0x4C83CFE9, 0xBED46A35,
	0xE349AA55, 0x3BD9E271, 0x07F1F67B, 0x0F0A058C,
	0x31D5E472, 0x171A0D88, 0x0EFFF1F6, 0xFCA8542A,
	0x84F87C3E, 0xD965BC5E, 0xD29C4E27, 0x89058C46,
	0x2830180C, 0x4389CA65, 0x6DBDD068, 0x5B99C261,
	0x0A0C0603, 0xBC239FC1, 0xEF41AE57, 0xCE7FB1D6,
	0xEC43AFD9, 0xCD7DB058, 0xEA47ADD8, 0x4985CC66,
	0xC87BB3D7, 0x9CE8743A, 0x8A078DC8, 0x88F0783C,
	0x26CFE9FA, 0x53623196, 0xF5A653A7, 0x775A2D98,
	0x5297C5EC, 0xB7DA6DB8, 0xA83B93C7, 0xC38241AE,
	0x6BB9D269, 0xA731964B, 0xDD964BAB, 0xD19E4FA9,
	0x4F81CE67, 0x3C28140A, 0x8F018E47, 0x16EFF9F2,
	0x99EE77B5, 0xCC884422, 0x64B3D7E5, 0x5E9FC1EE,
	0xA3C261BE, 0xFAAC562B, 0x213E1F81, 0x6C482412,
	0x2D361B83, 0x5A6C361B, 0x24381C0E, 0xCA8C4623,
	0x04F3F7F5, 0x83098A45, 0xC6844221, 0x9E1F81CE,
	0xAB399249, 0xE8B0582C, 0x2CC3EFF9, 0x6EBFD1E6,
	0x93E271B6, 0xF0A05028, 0x725C2E17, 0x2B321982,
	0x5C68341A, 0x1D160B8B, 0x3EDFE1FE, 0x1B12098A,
	0x36241209, 0x8C038FC9, 0x35261387, 0xB9259C4E,
	0x7CA3DFE1, 0xE4B85C2E, 0x62B7D5E4, 0x7AA7DDE0,
	0x408BCBEB, 0x477A3D90, 0xFFAA55A4, 0x44783C1E,
	0x392E1785, 0x5D9DC060, 0x00000000, 0xDE944A25,
	0x02F7F5F4, 0x1CE3FFF1, 0x5F6A3594, 0x3A2C160B,
	0x68BBD3E7, 0x23C9EA75, 0x589BC3EF, 0xB8D06834,
	0xA6C46231, 0xC277B5D4, 0xDA67BDD0, 0x33221186,
	0x19E5FC7E, 0xC98E47AD, 0x34D3E7FD, 0xF6A45229,
	0xA0C06030, 0x9AEC763B, 0x6546239F, 0x2AC7EDF8,
	0xAE3F91C6, 0x6A4C2613, 0x14180C06, 0x1E140A05,
	0xA43397C5, 0x66442211, 0x2FC1EE77, 0x15EDF87C,
	0x01F5F47A, 0x0DFDF078, 0xB4D86C36, 0x4870381C,
	0x96E47239, 0xCB79B259, 0x50603018, 0xE945AC56,
	0x8DF67BB3, 0x87FA7DB0, 0xD8904824, 0xC0804020,
	0x8BF279B2, 0x4B723992, 0xEDB65BA3, 0xBA279DC0,
	0x850D8844, 0x5195C462, 0x60402010, 0x9FEA75B4,
	0x3F2A1584, 0x97118643, 0x4D763B93, 0xB62F99C2,
	0xA135944A, 0xA9CE67BD, 0x0506038F, 0xEEB45A2D,
	0xAFCA65BC, 0x6F4A259C, 0x61B5D46A, 0x9D1D8040,
	0x981B83CF, 0xEBB259A2, 0x273A1D80, 0xBF219E4F,
	0x427C3E1F, 0x860F89CA, 0xDB9249AA, 0x91158442
};

static const uint32_t ks0[256] =
{
	0xBABABABA, 0x54545454, 0x2F2F2F2F, 0x74747474,
	0x53535353, 0xD3D3D3D3, 0xD2D2D2D2, 0x4D4D4D4D,
	0x50505050, 0xACACACAC, 0x8D8D8D8D, 0xBFBFBFBF,
	0x70707070, 0x52525252, 0x9A9A9A9A, 0x4C4C4C4C,
	0xEAEAEAEA, 0xD5D5D5D5, 0x97979797, 0xD1D1D1D1,
	0x33333333, 0x51515151, 0x5B5B5B5B, 0xA6A6A6A6,
	0xDEDEDEDE, 0x48484848, 0xA8A8A8A8, 0x99999999,
	0xDBDBDBDB, 0x32323232, 0xB7B7B7B7, 0xFCFCFCFC,
	0xE3E3E3E3, 0x9E9E9E9E, 0x91919191, 0x9B9B9B9B,
	0xE2E2E2E2, 0xBBBBBBBB, 0x41414141, 0x6E6E6E6E,
	0xA5A5A5A5, 0xCBCBCBCB, 0x6B6B6B6B, 0x95959595,
	0xA1A1A1A1, 0xF3F3F3F3, 0xB1B1B1B1, 0x02020202,
	0xCCCCCCCC, 0xC4C4C4C4, 0x1D1D1D1D, 0x14141414,
	0xC3C3C3C3, 0x63636363, 0xDADADADA, 0x5D5D5D5D,
	0x5F5F5F5F, 0xDCDCDCDC, 0x7D7D7D7D, 0xCDCDCDCD,
	0x7F7F7F7F, 0x5A5A5A5A, 0x6C6C6C6C, 0x5C5C5C5C,
	0xF7F7F7F7, 0x26262626, 0xFFFFFFFF, 0xEDEDEDED,
	0xE8E8E8E8, 0x9D9D9D9D, 0x6F6F6F6F, 0x8E8E8E8E,
	0x19191919, 0xA0A0A0A0, 0xF0F0F0F0, 0x89898989,
	0x0F0F0F0F, 0x07070707, 0xAFAFAFAF, 0xFBFBFBFB,
	0x08080808, 0x15151515, 0x0D0D0D0D, 0x04040404,
	0x01010101, 0x64646464, 0xDFDFDFDF, 0x76767676,
	0x79797979, 0xDDDDDDDD, 0x3D3D3D3D, 0x16161616,
	0x3F3F3F3F, 0x37373737, 0x6D6D6D6D, 0x38383838,
	0xB9B9B9B9, 0x73737373, 0xE9E9E9E9, 0x35353535,
	0x55555555, 0x71717171, 0x7B7B7B7B, 0x8C8C8C8C,
	0x72727272, 0x88888888, 0xF6F6F6F6, 0x2A2A2A2A,
	0x3E3E3E3E, 0x5E5E5E5E, 0x27272727, 0x46464646,
	0x0C0C0C0C, 0x65656565, 0x68686868, 0x61616161,
	0x03030303, 0xC1C1C1C1, 0x57575757, 0xD6D6D6D6,
	0xD9D9D9D9, 0x58585858, 0xD8D8D8D8, 0x66666666,
	0xD7D7D7D7, 0x3A3A3A3A, 0xC8C8C8C8, 0x3C3C3C3C,
	0xFAFAFAFA, 0x96969696, 0xA7A7A7A7, 0x98989898,
	0xECECECEC, 0xB8B8B8B8, 0xC7C7C7C7, 0xAEAEAEAE,
	0x69696969, 0x4B4B4B4B, 0xABABABAB, 0xA9A9A9A9,
	0x67676767, 0x0A0A0A0A, 0x47474747, 0xF2F2F2F2,
	0xB5B5B5B5, 0x22222222, 0xE5E5E5E5, 0xEEEEEEEE,
	0xBEBEBEBE, 0x2B2B2B2B, 0x81818181, 0x12121212,
	0x83838383, 0x1B1B1B1B, 0x0E0E0E0E, 0x23232323,
	0xF5F5F5F5, 0x45454545, 0x21212121, 0xCECECECE,
	0x49494949, 0x2C2C2C2C, 0xF9F9F9F9, 0xE6E6E6E6,
	0xB6B6B6B6, 0x28282828, 0x17171717, 0x82828282,
	0x1A1A1A1A, 0x8B8B8B8B, 0xFEFEFEFE, 0x8A8A8A8A,
	0x09090909, 0xC9C9C9C9, 0x87878787, 0x4E4E4E4E,
	0xE1E1E1E1, 0x2E2E2E2E, 0xE4E4E4E4, 0xE0E0E0E0,
	0xEBEBEBEB, 0x90909090, 0xA4A4A4A4, 0x1E1E1E1E,
	0x85858585, 0x60606060, 0x00000000, 0x25252525,
	0xF4F4F4F4, 0xF1F1F1F1, 0x94949494, 0x0B0B0B0B,
	0xE7E7E7E7, 0x75757575, 0xEFEFEFEF, 0x34343434,
	0x31313131, 0xD4D4D4D4, 0xD0D0D0D0, 0x86868686,
	0x7E7E7E7E, 0xADADADAD, 0xFDFDFDFD, 0x29292929,
	0x30303030, 0x3B3B3B3B, 0x9F9F9F9F, 0xF8F8F8F8,
	0xC6C6C6C6, 0x13131313, 0x06060606, 0x05050505,
	0xC5C5C5C5, 0x11111111, 0x77777777, 0x7C7C7C7C,
	0x7A7A7A7A, 0x78787878, 0x36363636, 0x1C1C1C1C,
	0x39393939, 0x59595959, 0x18181818, 0x56565656,
	0xB3B3B3B3, 0xB0B0B0B0, 0x24242424, 0x20202020,
	0xB2B2B2B2, 0x92929292, 0xA3A3A3A3, 0xC0C0C0C0,
	0x44444444, 0x62626262, 0x10101010, 0xB4B4B4B4,
	0x84848484, 0x43434343, 0x93939393, 0xC2C2C2C2,
	0x4A4A4A4A, 0xBDBDBDBD, 0x8F8F8F8F, 0x2D2D2D2D,
	0xBCBCBCBC, 0x9C9C9C9C, 0x6A6A6A6A, 0x40404040,
	0xCFCFCFCF, 0xA2A2A2A2, 0x80808080, 0x4F4F4F4F,
	0x1F1F1F1F, 0xCACACACA, 0xAAAAAAAA, 0x42424242
};

static const uint8_t ks1[256] =
{
	0x00, 0x02, 0x04, 0x06,	0x08, 0x0A, 0x0C, 0x0E,
	0x10, 0x12, 0x14, 0x16,	0x18, 0x1A, 0x1C, 0x1E,
	0x20, 0x22, 0x24, 0x26,	0x28, 0x2A, 0x2C, 0x2E,
	0x30, 0x32, 0x34, 0x36,	0x38, 0x3A, 0x3C, 0x3E,
	0x40, 0x42, 0x44, 0x46,	0x48, 0x4A, 0x4C, 0x4E,
	0x50, 0x52, 0x54, 0x56,	0x58, 0x5A, 0x5C, 0x5E,
	0x60, 0x62, 0x64, 0x66,	0x68, 0x6A, 0x6C, 0x6E,
	0x70, 0x72, 0x74, 0x76,	0x78, 0x7A, 0x7C, 0x7E,
	0x80, 0x82, 0x84, 0x86,	0x88, 0x8A, 0x8C, 0x8E,
	0x90, 0x92, 0x94, 0x96,	0x98, 0x9A, 0x9C, 0x9E,
	0xA0, 0xA2, 0xA4, 0xA6,	0xA8, 0xAA, 0xAC, 0xAE,
	0xB0, 0xB2, 0xB4, 0xB6,	0xB8, 0xBA, 0xBC, 0xBE,
	0xC0, 0xC2, 0xC4, 0xC6,	0xC8, 0xCA, 0xCC, 0xCE,
	0xD0, 0xD2, 0xD4, 0xD6,	0xD8, 0xDA, 0xDC, 0xDE,
	0xE0, 0xE2, 0xE4, 0xE6,	0xE8, 0xEA, 0xEC, 0xEE,
	0xF0, 0xF2, 0xF4, 0xF6,	0xF8, 0xFA, 0xFC, 0xFE,
	0x1D, 0x1F, 0x19, 0x1B,	0x15, 0x17, 0x11, 0x13,
	0x0D, 0x0F, 0x09, 0x0B,	0x05, 0x07, 0x01, 0x03,
	0x3D, 0x3F, 0x39, 0x3B,	0x35, 0x37, 0x31, 0x33,
	0x2D, 0x2F, 0x29, 0x2B,	0x25, 0x27, 0x21, 0x23,
	0x5D, 0x5F, 0x59, 0x5B,	0x55, 0x57, 0x51, 0x53,
	0x4D, 0x4F, 0x49, 0x4B,	0x45, 0x47, 0x41, 0x43,
	0x7D, 0x7F, 0x79, 0x7B,	0x75, 0x77, 0x71, 0x73,
	0x6D, 0x6F, 0x69, 0x6B,	0x65, 0x67, 0x61, 0x63,
	0x9D, 0x9F, 0x99, 0x9B,	0x95, 0x97, 0x91, 0x93,
	0x8D, 0x8F, 0x89, 0x8B,	0x85, 0x87, 0x81, 0x83,
	0xBD, 0xBF, 0xB9, 0xBB,	0xB5, 0xB7, 0xB1, 0xB3,
	0xAD, 0xAF, 0xA9, 0xAB,	0xA5, 0xA7, 0xA1, 0xA3,
	0xDD, 0xDF, 0xD9, 0xDB,	0xD5, 0xD7, 0xD1, 0xD3,
	0xCD, 0xCF, 0xC9, 0xCB,	0xC5, 0xC7, 0xC1, 0xC3,
	0xFD, 0xFF, 0xF9, 0xFB,	0xF5, 0xF7, 0xF1, 0xF3,
	0xED, 0xEF, 0xE9, 0xEB,	0xE5, 0xE7, 0xE1, 0xE3
};

static const uint32_t ks2[256] =
{
	0x00, 0x06, 0x0C, 0x0A, 0x18, 0x1E, 0x14, 0x12,
	0x30, 0x36, 0x3C, 0x3A, 0x28, 0x2E, 0x24, 0x22,
	0x60, 0x66, 0x6C, 0x6A, 0x78, 0x7E, 0x74, 0x72,
	0x50, 0x56, 0x5C, 0x5A, 0x48, 0x4E, 0x44, 0x42,
	0xC0, 0xC6, 0xCC, 0xCA, 0xD8, 0xDE, 0xD4, 0xD2,
	0xF0, 0xF6, 0xFC, 0xFA, 0xE8, 0xEE, 0xE4, 0xE2,
	0xA0, 0xA6, 0xAC, 0xAA, 0xB8, 0xBE, 0xB4, 0xB2,
	0x90, 0x96, 0x9C, 0x9A, 0x88, 0x8E, 0x84, 0x82,
	0x9D, 0x9B, 0x91, 0x97, 0x85, 0x83, 0x89, 0x8F,
	0xAD, 0xAB, 0xA1, 0xA7, 0xB5, 0xB3, 0xB9, 0xBF,
	0xFD, 0xFB, 0xF1, 0xF7, 0xE5, 0xE3, 0xE9, 0xEF,
	0xCD, 0xCB, 0xC1, 0xC7, 0xD5, 0xD3, 0xD9, 0xDF,
	0x5D, 0x5B, 0x51, 0x57, 0x45, 0x43, 0x49, 0x4F,
	0x6D, 0x6B, 0x61, 0x67, 0x75, 0x73, 0x79, 0x7F,
	0x3D, 0x3B, 0x31, 0x37, 0x25, 0x23, 0x29, 0x2F,
	0x0D, 0x0B, 0x01, 0x07, 0x15, 0x13, 0x19, 0x1F,
	0x27, 0x21, 0x2B, 0x2D, 0x3F, 0x39, 0x33, 0x35,
	0x17, 0x11, 0x1B, 0x1D, 0x0F, 0x09, 0x03, 0x05,
	0x47, 0x41, 0x4B, 0x4D, 0x5F, 0x59, 0x53, 0x55,
	0x77, 0x71, 0x7B, 0x7D, 0x6F, 0x69, 0x63, 0x65,
	0xE7, 0xE1, 0xEB, 0xED, 0xFF, 0xF9, 0xF3, 0xF5,
	0xD7, 0xD1, 0xDB, 0xDD, 0xCF, 0xC9, 0xC3, 0xC5,
	0x87, 0x81, 0x8B, 0x8D, 0x9F, 0x99, 0x93, 0x95,
	0xB7, 0xB1, 0xBB, 0xBD, 0xAF, 0xA9, 0xA3, 0xA5,
	0xBA, 0xBC, 0xB6, 0xB0, 0xA2, 0xA4, 0xAE, 0xA8,
	0x8A, 0x8C, 0x86, 0x80, 0x92, 0x94, 0x9E, 0x98,
	0xDA, 0xDC, 0xD6, 0xD0, 0xC2, 0xC4, 0xCE, 0xC8,
	0xEA, 0xEC, 0xE6, 0xE0, 0xF2, 0xF4, 0xFE, 0xF8,
	0x7A, 0x7C, 0x76, 0x70, 0x62, 0x64, 0x6E, 0x68,
	0x4A, 0x4C, 0x46, 0x40, 0x52, 0x54, 0x5E, 0x58,
	0x1A, 0x1C, 0x16, 0x10, 0x02, 0x04, 0x0E, 0x08,
	0x2A, 0x2C, 0x26, 0x20, 0x32, 0x34, 0x3E, 0x38
};

static const uint8_t ks3[256] =
{
	0x00, 0x08, 0x10, 0x18, 0x20, 0x28, 0x30, 0x38,
	0x40, 0x48, 0x50, 0x58, 0x60, 0x68, 0x70, 0x78,
	0x80, 0x88, 0x90, 0x98, 0xA0, 0xA8, 0xB0, 0xB8,
	0xC0, 0xC8, 0xD0, 0xD8, 0xE0, 0xE8, 0xF0, 0xF8,
	0x1D, 0x15, 0x0D, 0x05, 0x3D, 0x35, 0x2D, 0x25,
	0x5D, 0x55, 0x4D, 0x45, 0x7D, 0x75, 0x6D, 0x65,
	0x9D, 0x95, 0x8D, 0x85, 0xBD, 0xB5, 0xAD, 0xA5,
	0xDD, 0xD5, 0xCD, 0xC5, 0xFD, 0xF5, 0xED, 0xE5,
	0x3A, 0x32, 0x2A, 0x22, 0x1A, 0x12, 0x0A, 0x02,
	0x7A, 0x72, 0x6A, 0x62, 0x5A, 0x52, 0x4A, 0x42,
	0xBA, 0xB2, 0xAA, 0xA2, 0x9A, 0x92, 0x8A, 0x82,
	0xFA, 0xF2, 0xEA, 0xE2, 0xDA, 0xD2, 0xCA, 0xC2,
	0x27, 0x2F, 0x37, 0x3F, 0x07, 0x0F, 0x17, 0x1F,
	0x67, 0x6F, 0x77, 0x7F, 0x47, 0x4F, 0x57, 0x5F,
	0xA7, 0xAF, 0xB7, 0xBF, 0x87, 0x8F, 0x97, 0x9F,
	0xE7, 0xEF, 0xF7, 0xFF, 0xC7, 0xCF, 0xD7, 0xDF,
	0x74, 0x7C, 0x64, 0x6C, 0x54, 0x5C, 0x44, 0x4C,
	0x34, 0x3C, 0x24, 0x2C, 0x14, 0x1C, 0x04, 0x0C,
	0xF4, 0xFC, 0xE4, 0xEC, 0xD4, 0xDC, 0xC4, 0xCC,
	0xB4, 0xBC, 0xA4, 0xAC, 0x94, 0x9C, 0x84, 0x8C,
	0x69, 0x61, 0x79, 0x71, 0x49, 0x41, 0x59, 0x51,
	0x29, 0x21, 0x39, 0x31, 0x09, 0x01, 0x19, 0x11,
	0xE9, 0xE1, 0xF9, 0xF1, 0xC9, 0xC1, 0xD9, 0xD1,
	0xA9, 0xA1, 0xB9, 0xB1, 0x89, 0x81, 0x99, 0x91,
	0x4E, 0x46, 0x5E, 0x56, 0x6E, 0x66, 0x7E, 0x76,
	0x0E, 0x06, 0x1E, 0x16, 0x2E, 0x26, 0x3E, 0x36,
	0xCE, 0xC6, 0xDE, 0xD6, 0xEE, 0xE6, 0xFE, 0xF6,
	0x8E, 0x86, 0x9E, 0x96, 0xAE, 0xA6, 0xBE, 0xB6,
	0x53, 0x5B, 0x43, 0x4B, 0x73, 0x7B, 0x63, 0x6B,
	0x13, 0x1B, 0x03, 0x0B, 0x33, 0x3B, 0x23, 0x2B,
	0xD3, 0xDB, 0xC3, 0xCB, 0xF3, 0xFB, 0xE3, 0xEB,
	0x93, 0x9B, 0x83, 0x8B, 0xB3, 0xBB, 0xA3, 0xAB
};

static const uint32_t rc[64] =
{
	0xBA542F74, 0x53D3D24D, 0x50AC8DBF, 0x70529A4C,
	0xEAD597D1, 0x33515BA6, 0xDE48A899, 0xDB32B7FC,
	0xE39E919B, 0xE2BB416E, 0xA5CB6B95, 0xA1F3B102,
	0xCCC41D14, 0xC363DA5D, 0x5FDC7DCD, 0x7F5A6C5C,
	0xF726FFED, 0xE89D6F8E, 0x19A0F089, 0x0F07AFFB,
	0x08150D04, 0x0164DF76, 0x79DD3D16, 0x3F376D38,
	0xB973E935, 0x55717B8C, 0x7288F62A, 0x3E5E2746,
	0x0C656861, 0x03C157D6, 0xD958D866, 0xD73AC83C,
	0xFA96A798, 0xECB8C7AE, 0x694BABA9, 0x670A47F2,
	0xB522E5EE, 0xBE2B8112, 0x831B0E23, 0xF54521CE,
	0x492CF9E6, 0xB6281782, 0x1A8BFE8A, 0x09C9874E,
	0xE12EE4E0, 0xEB90A41E, 0x85600025, 0xF4F1940B,
	0xE775EF34, 0x31D4D086, 0x7EADFD29, 0x303B9FF8,
	0xC6130605, 0xC511777C, 0x7A78361C, 0x39591856,
	0xB3B02420, 0xB292A3C0, 0x446210B4, 0x844393C2,
	0x4ABD8F2D, 0xBC9C6A40, 0xCFA2804F, 0x1FCAAA42
};

static void anubis_crypt
(
	const uint32_t *k,
	unsigned int r,
	const void *in,
	void *out
)
{
	uint32_t x0;
	uint32_t x1;
	uint32_t x2;
	uint32_t x3;
	uint32_t t0;
	uint32_t t1;
	uint32_t t2;
	uint32_t t3;
	unsigned int i;

	x0 = LOAD32B(CU8(in)) ^ k[0];
	x1 = LOAD32B(CU8(in) + 4) ^ k[1];
	x2 = LOAD32B(CU8(in) + 8) ^ k[2];
	x3 = LOAD32B(CU8(in) + 12) ^ k[3];

	/* r - 1 full rounds */
	for(i = 4; i < (r << 2);)
	{
		t0 = s0[x0 >> 24] ^
			s1[x1 >> 24] ^
			s2[x2 >> 24] ^
			s3[x3 >> 24] ^
			k[i++];

		t1 = s0[(x0 >> 16) & 0xFF] ^
			s1[(x1 >> 16) & 0xFF] ^
			s2[(x2 >> 16) & 0xFF] ^
			s3[(x3 >> 16) & 0xFF] ^
			k[i++];

		t2 = s0[(x0 >> 8) & 0xFF] ^
			s1[(x1 >> 8) & 0xFF] ^
			s2[(x2 >> 8) & 0xFF] ^
			s3[(x3 >> 8) & 0xFF] ^
			k[i++];

		t3 = s0[x0 & 0xFF] ^
			s1[x1 & 0xFF] ^
			s2[x2 & 0xFF] ^
			s3[x3 & 0xFF] ^
			k[i++];

		x0 = t0;
		x1 = t1;
		x2 = t2;
		x3 = t3;
	}

	/* last round */
	t0 = ((s0[x0 >> 24] & 0xFF000000) |
		(s1[x1 >> 24] & 0x00FF0000) |
		(s2[x2 >> 24] & 0x0000FF00) |
		(s3[x3 >> 24] & 0x000000FF)) ^
		k[i++];

	t1 = ((s0[(x0 >> 16) & 0xFF] & 0xFF000000) |
		(s1[(x1 >> 16) & 0xFF] & 0x00FF0000) |
		(s2[(x2 >> 16) & 0xFF] & 0x0000FF00) |
		(s3[(x3 >> 16) & 0xFF] & 0x000000FF)) ^
		k[i++];

	t2 = ((s0[(x0 >> 8) & 0xFF] & 0xFF000000) |
		(s1[(x1 >> 8) & 0xFF] & 0x00FF0000) |
		(s2[(x2 >> 8) & 0xFF] & 0x0000FF00) |
		(s3[(x3 >> 8) & 0xFF] & 0x000000FF)) ^
		k[i++];

	t3 = ((s0[x0 & 0xFF] & 0xFF000000) |
		(s1[x1 & 0xFF] & 0x00FF0000) |
		(s2[x2 & 0xFF] & 0x0000FF00) |
		(s3[x3 & 0xFF] & 0x000000FF)) ^
		k[i++];

	STORE32B(t0, U8(out));
	STORE32B(t1, U8(out) + 4);
	STORE32B(t2, U8(out) + 8);
	STORE32B(t3, U8(out) + 12);
}

static void anubis_setup
(
	kripto_block *s,
	const uint8_t *key,
	unsigned int key_len
)
{
	int i;
	int j;
	unsigned int r;
	const unsigned int n = (key_len + 3) >> 2;
	uint32_t t0;
	uint32_t t1;
	uint32_t t2;
	uint32_t t3;
	uint32_t x[80];
	uint32_t kx[80];

	for(r = 0; r < n; r++) kx[r] = 0;

	for(r = 0; r < key_len; r++)
		kx[r >> 2] |= key[r] << (24 - ((r & 3) << 3));

	/* generate s->rounds + 1 round keys  */
	for(r = 0; r <= s->rounds; r++)
	{
		/* generate r-th round key K^r */
		t0 = ks0[kx[n - 1] >> 24];
		t1 = ks0[(kx[n - 1] >> 16) & 0xFF];
		t2 = ks0[(kx[n - 1] >> 8) & 0xFF];
		t3 = ks0[kx[n - 1] & 0xFF];

		for(i = n - 2; i >= 0; i--)
		{
			t0 = ks0[kx[i] >> 24] ^
				((t0 & 0xFF000000) |
				(ks1[(t0 >> 16) & 0xFF] << 16) |
				(ks2[(t0 >> 8) & 0xFF] << 8) |
				ks3[t0 & 0xFF]);

			t1 = ks0[(kx[i] >> 16) & 0xFF] ^
				((t1 & 0xFF000000) |
				(ks1[(t1 >> 16) & 0xFF] << 16) |
				(ks2[(t1 >> 8) & 0xFF] << 8) |
				ks3[t1 & 0xFF]);

			t2 = ks0[(kx[i] >> 8) & 0xFF] ^
				((t2 & 0xFF000000) |
				(ks1[(t2 >> 16) & 0xFF] << 16) |
				(ks2[(t2 >> 8) & 0xFF] << 8) |
				ks3[t2 & 0xFF]);

			t3 = ks0[kx[i] & 0xFF] ^
				((t3 & 0xFF000000) |
				(ks1[(t3 >> 16) & 0xFF] << 16) |
				(ks2[(t3 >> 8) & 0xFF] << 8) |
				ks3[t3 & 0xFF]);
		}

		s->k[r << 2] = t0;
		s->k[(r << 2) + 1] = t1;
		s->k[(r << 2) + 2] = t2;
		s->k[(r << 2) + 3] = t3;

		if(r == s->rounds) break;

		/* compute kx^{r+1} from kx^r */
		for(i = 0; (unsigned int)i < n; i++)
		{
			j = i;
			x[i] = s0[kx[j--] >> 24]; if(j < 0) j = n - 1;
			x[i] ^= s1[(kx[j--] >> 16) & 0xFF]; if(j < 0) j = n - 1;
			x[i] ^= s2[(kx[j--] >> 8) & 0xFF]; if(j < 0) j = n - 1;
			x[i] ^= s3[kx[j] & 0xFF];
		}
		kx[0] = x[0] ^ rc[r];
		for(i = 1; (unsigned int)i < n; i++) kx[i] = x[i];
	}

	/* wipe */
	kripto_memwipe(x, n << 2);
	kripto_memwipe(kx, n << 2);
	kripto_memwipe(&t1, sizeof(uint32_t));
	kripto_memwipe(&t2, sizeof(uint32_t));
	kripto_memwipe(&t3, sizeof(uint32_t));

	/* generate inverse key schedule */
	for(i = 0; i < 4; i++)
	{
		s->dk[i] = s->k[(s->rounds << 2) + i];
		s->dk[(s->rounds << 2) + i] = s->k[i];
	}
	for(r = 1; r < s->rounds; r++)
	{
		for(i = 0; i < 4; i++)
		{
			t0 = s->k[((s->rounds - r) << 2) + i];

			s->dk[(r << 2) + i] = s0[ks0[t0 >> 24] & 0xFF] ^
				s1[ks0[(t0 >> 16) & 0xFF] & 0xFF] ^
				s2[ks0[(t0 >> 8) & 0xFF] & 0xFF] ^
				s3[ks0[t0 & 0xFF] & 0xFF];
		}
	}

	/* wipe */
	kripto_memwipe(&t0, sizeof(uint32_t));
}

static void anubis_encrypt
(
	const kripto_block *s,
	const void *pt,
	void *ct
)
{
	anubis_crypt(s->k, s->rounds, pt, ct);
}

static void anubis_decrypt
(
	const kripto_block *s,
	const void *ct,
	void *pt
)
{
	anubis_crypt(s->dk, s->rounds, ct, pt);
}

static kripto_block *anubis_create
(
	unsigned int r,
	const void *key,
	unsigned int key_len
)
{
	kripto_block *s;

	if(!r)
	{
		r = 8 + ((key_len + 3) >> 2);
		if(r < 12) r = 12;
	}

	s = malloc(sizeof(kripto_block) + ((r + 1) << 5));
	if(!s) return 0;

	s->obj.desc = kripto_block_anubis;
	s->size = sizeof(kripto_block) + ((r + 1) << 5);
	s->rounds = r;
	s->k = (uint32_t *)((uint8_t *)s + sizeof(kripto_block));
	s->dk = s->k + ((r + 1) << 2);

	anubis_setup(s, key, key_len);

	return s;
}

static void anubis_destroy(kripto_block *s)
{
	kripto_memwipe(s, s->size);
	free(s);
}

static kripto_block *anubis_recreate
(
	kripto_block *s,
	unsigned int r,
	const void *key,
	unsigned int key_len
)
{
	if(!r)
	{
		r = 8 + ((key_len + 3) >> 2);
		if(r < 12) r = 12;
	}

	if(sizeof(kripto_block) + ((r + 1) << 5) > s->size)
	{
		anubis_destroy(s);
		s = anubis_create(r, key, key_len);
	}
	else
	{
		s->rounds = r;
		anubis_setup(s, key, key_len);
	}

	return s;
}

static const kripto_block_desc anubis =
{
	&anubis_create,
	&anubis_recreate,
	0,
	&anubis_encrypt,
	&anubis_decrypt,
	&anubis_destroy,
	"Anubis",
	16, /* block size */
	40 /* max key */
};

const kripto_block_desc *const kripto_block_anubis = &anubis;
